<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8">  <meta name="built-on" content="2022-09-29T19:15:57.9945295"><meta name="build-number" content="${buildNumber}">    <meta name="keywords" content="">  <title>Dynamic Plugins | IntelliJ Platform Plugin SDK</title><script id="virtual-toc-data" type="application/json">[{"id":"restrictions","level":0,"title":"Restrictions","anchor":"#restrictions"},{"id":"code","level":0,"title":"Code","anchor":"#code"},{"id":"troubleshooting","level":0,"title":"Troubleshooting","anchor":"#troubleshooting"}]</script>   <link href="https://resources.jetbrains.com/storage/help-app/v5/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- Open Graph --><meta property="og:title" content="Dynamic Plugins | IntelliJ Platform Plugin SDK"/><meta property="og:description" content=""/><meta property="og:image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"/><meta property="og:site_name" content="IntelliJ Platform Plugin SDK Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="https://plugins.jetbrains.com/docs/intellij/dynamic-plugins.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@JBPlatform"><meta name="twitter:title" content="Dynamic Plugins | IntelliJ Platform Plugin SDK"><meta name="twitter:description" content=""><meta name="twitter:creator" content="@JBPlatform"><meta name="twitter:image:src" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "https://plugins.jetbrains.com/docs/intellij/dynamic-plugins.html#webpage", "url": "https://plugins.jetbrains.com/docs/intellij/dynamic-plugins.html", "name": "Dynamic Plugins | IntelliJ Platform Plugin SDK", "description": "", "image": "https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "https://plugins.jetbrains.com/docs/intellij/#website", "url": "https://plugins.jetbrains.com/docs/intellij/", "name": "IntelliJ Platform Plugin SDK Help" }</script><!-- End Schema.org --></head>    <body data-id="dynamic_plugins.md" data-main-title="Dynamic Plugins" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Part I — 插件"  data-edit-url="https://github.com/JetBrains/intellij-sdk-docs/edit/main/topics/basics/plugin_structure/dynamic_plugins.md"  >  <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>IntelliJ Platform Plugin SDK  Help</h3><div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select class="select _shortcuts" height="1" id="switch-shortcuts">      </select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="dynamic_plugins.md" id="dynamic_plugins.md"  >Dynamic Plugins</h1><p id="c9e1742b_107" >Starting with the <span class="control" id="c9e1742b_108" >2020.1</span> release, installing, updating, and uninstalling plugins without restarting the IDE is available in the IntelliJ Platform.</p><p id="c9e1742b_109" >During plugin development, <a href="ide-development-instance.html#enabling-auto-reload" id="c9e1742b_110" data-tooltip="Starting in 2020.1, this is available for compatible dynamic plugins. This allows a much faster development cycle by avoiding a full restart of the development instance after detecting code changes (when JARs are modified)."  >Auto-Reload</a> also allows code changes to take effect immediately in the sandbox IDE instance. To test whether dynamic installation works correctly, verify installing <a href="deployment.html#building-distribution" id="c9e1742b_111" data-tooltip="For initial upload, manual distribution or local installation, invoke the buildPlugin Gradle task to create the plugin distribution. The resulting ZIP file is located in build/distributions and can then be installed via drag & drop (or using plugin manager) or uploaded to a ."  >local build distribution</a> succeeds (see <a href="#troubleshooting" id="c9e1742b_112" data-tooltip="When a plugin is being uninstalled or updated, the IDE waits synchronously for plugin unload and asks for restart if the unload failed."  >Troubleshooting</a>).</p><p id="c9e1742b_113" >Please note that any unloading problems in a production environment will simply ask the user to restart the IDE.</p><aside data-type="tip" class="prompt" data-title="" id="c9e1742b_114" ><p id="c9e1742b_115" >If a plugin <span class="emphasis" id="c9e1742b_116" >requires</span> restart (e.g., due to using native libraries) specify <code class="code " id="c9e1742b_117"  >require-restart=&quot;true&quot;</code> for <a href="plugin-configuration-file.html#idea-plugin" id="c9e1742b_118" data-tooltip="The plugin.xml file root element."  ><code class="code " id="c9e1742b_119"  >&lt;idea-plugin&gt;</code></a> root tag in <span class="filepath" id="c9e1742b_120" ><a href="plugin-configuration-file.html" id="c9e1742b_121" data-tooltip="Plugin configuration file contains all the information about the plugin, as well as all registered extensions, actions, listeners, etc."  >plugin.xml</a></span>.</p></aside><section class="chapter"  ><h2 id="restrictions" data-toc="restrictions"  >Restrictions</h2><p id="c9e1742b_122" >For a plugin to support this, all restrictions listed below must be met. To verify a plugin locally, invoke  and run <span class="control" id="c9e1742b_124" >Plugin DevKit | Plugin descriptor | Plugin.xml dynamic plugin verification inspection</span> inspection on all plugin descriptor files.</p><p id="c9e1742b_125" >For plugins hosted on the <a href="https://plugins.jetbrains.com" id="c9e1742b_126"   data-external="true" rel="noopener noreferrer" >JetBrains Marketplace</a> the built-in <a href="https://blog.jetbrains.com/platform/2018/07/plugins-repository-now-integrates-with-the-plugin-verification-tool/" id="c9e1742b_127"   data-external="true" rel="noopener noreferrer" >Plugin Verifier</a> will run these checks automatically. See <a href="verifying-plugin-compatibility.html#plugin-verifier" id="c9e1742b_128" data-tooltip="Compatibility with newer IDEs can easily be verified for plugins hosted on the JetBrains Marketplace using the built-in Plugin Verifier."  >Plugin Verifier</a> for more information on how to run it locally or on CI.</p><section class="chapter"  ><h3 id="no-use-of-components" data-toc="no-use-of-components"  >No Use of Components</h3><p id="c9e1742b_129" >No Components must be used; existing ones <a href="plugin-components.html" id="c9e1742b_130" data-tooltip="When writing new plugins, creating Components should be avoided. Any existing Components should be migrated to services, extensions, or listeners (see below)."  >must be migrated</a> to services, extensions, or listeners.</p></section><section class="chapter"  ><h3 id="action-group-requires-id" data-toc="action-group-requires-id"  >Action Group Requires ID</h3><p id="c9e1742b_131" >All <a href="plugin-configuration-file.html#idea-plugin__actions__group" id="c9e1742b_132" data-tooltip="Defines an action group. The <action>, <group> and <separator> elements defined inside the group are automatically included in it. The <group> elements can be nested."  ><code class="code " id="c9e1742b_133"  >&lt;group&gt;</code></a> elements must declare a unique <code class="code " id="c9e1742b_134"  >id</code>.</p></section><section class="chapter"  ><h3 id="use-only-dynamic-extensions" data-toc="use-only-dynamic-extensions"  >Use Only Dynamic Extensions</h3><p id="c9e1742b_135" >Whether defined in the platform itself (<a href="extension-point-list.html" id="c9e1742b_136" data-tooltip="IntelliJ Platform的扩展点和监听器一览"  >扩展点和监听器列表</a>) or coming from other plugins, all used extension points must be marked explicitly as dynamic (see next paragraph).</p><p id="c9e1742b_137" >Some deprecated extension points (e.g., <code class="code " id="c9e1742b_138"  >com.intellij.configurationProducer</code>) are intentionally non-dynamic, and their usage should be migrated to the corresponding replacement.</p></section><section class="chapter"  ><h3 id="mark-extension-points-as-dynamic" data-toc="mark-extension-points-as-dynamic"  >Mark Extension Points as Dynamic</h3><p id="c9e1742b_139" >If a plugin defines its own custom extension points, they must adhere to specific usage rules and then <a href="plugin-extension-points.html#dynamic-extension-points" id="c9e1742b_140" data-tooltip="To support Dynamic Plugins (2020.1 and later), an extension point must adhere to specific usage rules:"  >be declared</a> ready for dynamic use explicitly.</p></section><section class="chapter"  ><h3 id="configurables-depending-on-extension-points" data-toc="configurables-depending-on-extension-points"  >Configurables Depending on Extension Points</h3><p id="c9e1742b_141" >Any <code class="code " id="c9e1742b_142"  >Configurable</code> which depends on dynamic extension points must implement <code class="code " id="c9e1742b_143"  >Configurable.WithEpDependencies</code>.</p></section><section class="chapter"  ><h3 id="no-use-of-service-overrides" data-toc="no-use-of-service-overrides"  >No Use of Service Overrides</h3><p id="c9e1742b_144" >Application, project, and module <a href="plugin-services.html" id="c9e1742b_145" data-tooltip="A service is a plugin component loaded on demand when your plugin calls the getService() method of corresponding ComponentManager instance (see Types). The IntelliJ Platform ensures that only one instance of a service is loaded even though it is called several times."  >services</a> declared with <code class="code " id="c9e1742b_146"  >overrides=&quot;true&quot;</code> are not allowed.</p></section></section><section class="chapter"  ><h2 id="code" data-toc="code"  >Code</h2><aside data-type="tip" class="prompt" data-title="" id="c9e1742b_147" ><p id="c9e1742b_148" >Loading and unloading plugins happens in EDT and under write action.</p></aside><section class="chapter"  ><h3 id="cachedvalue" data-toc="cachedvalue"  >CachedValue</h3><p id="c9e1742b_149" >Loading/Unloading a plugin clears all cached values created using <code class="code " id="c9e1742b_150"  >CachedValuesManager</code>.</p></section><section class="chapter"  ><h3 id="do-not-store-psi" data-toc="do-not-store-psi"  >Do not Store PSI</h3><p id="c9e1742b_151" >Do not store references to PSI elements in objects which can survive plugin loading or unloading; use <code class="code " id="c9e1742b_152"  >SmartPsiElementPointer</code> instead.</p></section><section class="chapter"  ><h3 id="do-not-use-filetypelanguage-as-map-key" data-toc="do-not-use-filetypelanguage-as-map-key"  >Do not Use FileType/Language as Map Key</h3><p id="c9e1742b_153" >Replace with <code class="code " id="c9e1742b_154"  >String</code> from <code class="code " id="c9e1742b_155"  >Language.getID()</code>/<code class="code " id="c9e1742b_156"  >FileType.getName()</code> (use inspection <span class="control" id="c9e1742b_157" >Plugin DevKit | Code | Map key may leak</span>).</p></section><section class="chapter"  ><h3 id="plugin-loadunload-events" data-toc="plugin-loadunload-events"  >Plugin Load/Unload Events</h3><p id="c9e1742b_158" >Register <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/ide/plugins/DynamicPluginListener.kt" id="c9e1742b_159"   data-external="true" rel="noopener noreferrer" ><code class="code " id="c9e1742b_160"  >DynamicPluginListener</code></a> <a href="plugin-listeners.html" id="c9e1742b_161" data-tooltip="Listeners allow subscription to application and project events."  >application listener</a> to receive updates on plugin load/unload events.</p><p id="c9e1742b_162" >This can be used to e.g., cancel long-running activities or disallow unload due to ongoing processes.</p></section></section><section class="chapter"  ><h2 id="troubleshooting" data-toc="troubleshooting"  >Troubleshooting</h2><p id="c9e1742b_163" >When a plugin is being uninstalled or updated, the IDE waits synchronously for plugin unload and asks for restart if the unload failed.</p><p id="c9e1742b_164" >Use the latest available version of the target IDE for verification. See also this <a href="https://youtrack.jetbrains.com/issues/IDEA?q=%23dynamic-plugins%20" id="c9e1742b_165"   data-external="true" rel="noopener noreferrer" >list of known platform issues</a> related to handling dynamic plugins.</p><section class="chapter"  ><h3 id="logging" data-toc="logging"  >Logging</h3><p id="c9e1742b_166" >All events are tracked under <code class="code " id="c9e1742b_167"  >com.intellij.ide.plugins.DynamicPlugins</code> category in IDE log file. If a plugin fails to reload, the log will contain a cause as to why.</p></section><section class="chapter"  ><h3 id="diagnosing-leaks" data-toc="diagnosing-leaks"  >Diagnosing Leaks</h3><section class="procedure-steps"   ><h3 id="c9e1742b_168" data-toc="c9e1742b_168">Finding leaks preventing unload</h3 ><ol class="list _decimal" id="c9e1742b_169"  type="1"  ><li class="list__item" id="c9e1742b_170" ><p>Verify that the IDE is running with the VM parameter <code class="code " id="c9e1742b_171"  >-XX:+UnlockDiagnosticVMOptions</code>. When using <a href="gradle-guide.html" id="c9e1742b_172" data-tooltip="This page serves as a guide to Gradle-based plugin configuration for IntelliJ Platform projects. The IntelliJ IDEA Ultimate and Community editions bundle the Gradle and Plugin DevKit plugins to support Gradle-based development."  >Gradle</a>, specify <code class="code " id="c9e1742b_173"  >runIde.jvmArgs += &quot;-XX:+UnlockDiagnosticVMOptions&quot;</code> otherwise <a href="https://www.jetbrains.com/help/idea/tuning-the-ide.html#procedure-jvm-options" id="c9e1742b_174"   data-external="true" rel="noopener noreferrer" >Configure JVM Options</a>.</p></li><li class="list__item" id="c9e1742b_175" ><p>Set Registry key <code class="code " id="c9e1742b_176"  >ide.plugins.snapshot.on.unload.fail</code> to <code class="code " id="c9e1742b_177"  >true</code> (Go to </p><p> and type <code class="code " id="c9e1742b_179"  >Registry</code>).</p></li><li class="list__item" id="c9e1742b_180" ><p>Trigger the plugin reload.</p></li><li class="list__item" id="c9e1742b_181" ><p>Open the <span class="filepath" id="c9e1742b_182" >.hprof</span> memory snapshot generated on plugin unload, look for the plugin ID string. <a href="https://www.jetbrains.com/help/idea/analyze-hprof-memory-snapshots.html" id="c9e1742b_183"   data-external="true" rel="noopener noreferrer" >IntelliJ Ultimate</a> can open memory snapshots directly.</p></li><li class="list__item" id="c9e1742b_184" ><p>Find the <code class="code " id="c9e1742b_185"  >PluginClassLoader</code> referencing the plugin ID string</p></li><li class="list__item" id="c9e1742b_186" ><p>Look at references to the <code class="code " id="c9e1742b_187"  >PluginClassLoader</code> instance.</p></li><li class="list__item" id="c9e1742b_188" ><p>Every one of them is a memory leak (or part of a memory leak) that needs to be resolved.</p></li></ol><ol class="list _decimal"></ol></section><p id="c9e1742b_189" >When you've completed step 1 and 2, the log will contain more information about the memory leak, for instance the following shows a chain of field references that is keeping the class loader in memory.</p><div class="code-block" data-lang="plaintext"         >
2020-12-26 14:43:24,563 [ 251086]   INFO - lij.ide.plugins.DynamicPlugins - Snapshot analysis result: Root 1:
  ROOT: Global JNI
  sun.awt.X11.XInputMethod.clientComponentWindow
  com.intellij.openapi.wm.impl.IdeFrameImpl.rootPane
  com.intellij.openapi.wm.impl.IdeRootPane.myToolbar
  com.intellij.openapi.actionSystem.impl.ActionToolbarImpl.myVisibleActions
  java.util.ArrayList.elementData
  java.lang.Object[]
  com.example.ActionExample.&lt;class&gt;
  com.example.ActionExample.&lt;loader&gt;
* com.intellij.ide.plugins.cl.PluginClassLoader
</div><section class="chapter"  ><h4 id="other-tips" data-toc="other-tips"  >Other Tips</h4><ol class="list _decimal" id="c9e1742b_191"  type="1"  ><li class="list__item" id="c9e1742b_192" ><p>Try a newer version of the IDE, in some cases platform bugs might be an issue.</p></li><li class="list__item" id="c9e1742b_193" ><p>Try in a fresh and new configuration (e.g., clean the <a href="ide-development-instance.html#the-development-instance-sandbox-directory" id="c9e1742b_194" data-tooltip="The Sandbox Home directory contains the settings, caches, logs, and plugins for a Development Instance of the IDE. This information is stored in a different location than for the installed IDE itself."  >sandbox</a> or use a different configuration directory).</p></li></ol></section></section></section><div class="last-modified"> Last modified: 29 九月 2022</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="plugin-dependencies.html">Dependencies</a>   <a class="navigation-links__next" href="intellij-artifacts.html">IntelliJ Platform Artifacts Repositories</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/storage/help-app/v5/app.js"></script></body></html>