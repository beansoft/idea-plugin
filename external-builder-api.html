<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8">  <meta name="built-on" content="2022-09-28T11:33:50.3744318"><meta name="build-number" content="${buildNumber}">    <meta name="keywords" content="">  <title>External Builder API and Plugins | IntelliJ Platform Plugin SDK</title><script id="virtual-toc-data" type="application/json">[{"id":"external-build-process-workflow","level":0,"title":"External Build Process Workflow","anchor":"#external-build-process-workflow"},{"id":"incremental-build","level":0,"title":"Incremental Build","anchor":"#incremental-build"},{"id":"services-and-extensions-in-external-builder","level":0,"title":"Services and Extensions in External Builder","anchor":"#services-and-extensions-in-external-builder"},{"id":"registering-a-plugin-for-external-builder","level":0,"title":"Registering a Plugin for External Builder","anchor":"#registering-a-plugin-for-external-builder"},{"id":"debugging-a-plugin-for-external-builder","level":0,"title":"Debugging a Plugin for External Builder","anchor":"#debugging-a-plugin-for-external-builder"},{"id":"profiling-external-build-process","level":0,"title":"Profiling External Build Process","anchor":"#profiling-external-build-process"},{"id":"accessing-external-build-process-logs","level":0,"title":"Accessing External Build Process\u0027 Logs","anchor":"#accessing-external-build-process-logs"},{"id":"accessing-project-model-and-configuration-from-external-build","level":0,"title":"Accessing Project Model and Configuration from External Build","anchor":"#accessing-project-model-and-configuration-from-external-build"}]</script>   <link href="https://resources.jetbrains.com/storage/help-app/v5/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- Open Graph --><meta property="og:title" content="External Builder API and Plugins | IntelliJ Platform Plugin SDK"/><meta property="og:description" content=""/><meta property="og:image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"/><meta property="og:site_name" content="IntelliJ Platform Plugin SDK Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="https://plugins.jetbrains.com/docs/intellij/external-builder-api.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@JBPlatform"><meta name="twitter:title" content="External Builder API and Plugins | IntelliJ Platform Plugin SDK"><meta name="twitter:description" content=""><meta name="twitter:creator" content="@JBPlatform"><meta name="twitter:image:src" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "https://plugins.jetbrains.com/docs/intellij/external-builder-api.html#webpage", "url": "https://plugins.jetbrains.com/docs/intellij/external-builder-api.html", "name": "External Builder API and Plugins | IntelliJ Platform Plugin SDK", "description": "", "image": "https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "https://plugins.jetbrains.com/docs/intellij/#website", "url": "https://plugins.jetbrains.com/docs/intellij/", "name": "IntelliJ Platform Plugin SDK Help" }</script><!-- End Schema.org --></head>    <body data-id="external_builder_api.md" data-main-title="External Builder API and Plugins" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Part V — Features///build_system.md|Build System"  data-edit-url="https://github.com/JetBrains/intellij-sdk-docs/edit/main/topics/reference_guide/frameworks_and_external_apis/external_builder_api.md"  >  <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>IntelliJ Platform Plugin SDK  Help</h3><div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select class="select _shortcuts" height="1" id="switch-shortcuts">      </select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="external_builder_api.md" id="external_builder_api.md"  >External Builder API and Plugins</h1><aside data-type="tip" class="prompt" data-title="" id="dd07e79d_1" ><p id="dd07e79d_2" >Adding JPS support to your plugin requires Java plugin to be present for it to work. Please see <a href="plugin-dependencies.html" id="dd07e79d_3" data-tooltip="A plugin may depend on classes from other plugins, either bundled, third-party, or by the same author. This document describes the syntax for declaring plugin dependencies and optional plugin dependencies. For more information about dependencies on the IntelliJ Platform modules, see…"  >Plugin Dependencies</a> on how to set up your plugin with required dependency.</p></aside><section class="chapter"  ><h2 id="external-build-process-workflow" data-toc="external-build-process-workflow"  >External Build Process Workflow</h2><p id="dd07e79d_4" >When the user invokes an action that involves executing an external build (Make, Build Artifacts, etc.), the following steps happen:</p><ul class="list _ul" id="dd07e79d_5"    ><li class="list__item" id="dd07e79d_6" ><p>Before-compile tasks are performed in the IDE process.</p></li><li class="list__item" id="dd07e79d_7" ><p>Some source generation tasks that depend on the PSI (e.g., UI designer form to source compilation) are executed in the IDE process.</p></li><li class="list__item" id="dd07e79d_8" ><p><a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/java/compiler/impl/src/com/intellij/compiler/impl/BuildTargetScopeProvider.java" id="dd07e79d_9"   data-external="true" rel="noopener noreferrer" ><code class="code " id="dd07e79d_10"  >BuildTargetScopeProvider</code></a> extensions are called to calculate the scope of the external build (the set of build targets to compile based on the target module to make and the known set of changes).</p></li><li class="list__item" id="dd07e79d_11" ><p>The external build process is spawned (or an existing build process background process is reused).</p></li><li class="list__item" id="dd07e79d_12" ><p>The external build process loads the project model (<span class="filepath" id="dd07e79d_13" >.idea</span>, <span class="filepath" id="dd07e79d_14" >.iml</span> files, and so on), represented by a <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/jps/model-api/src/org/jetbrains/jps/model/JpsModel.java" id="dd07e79d_15"   data-external="true" rel="noopener noreferrer" ><code class="code " id="dd07e79d_16"  >JpsModel</code></a> instance.</p></li><li class="list__item" id="dd07e79d_17" ><p>The full tree of targets to build is calculated based on each build target's dependencies to be compiled.</p></li><li class="list__item" id="dd07e79d_18" ><p>For each target, the set of builders capable of building this target is calculated.</p></li><li class="list__item" id="dd07e79d_19" ><p>For every target and every builder, the <code class="code " id="dd07e79d_20"  >build()</code> method is called. This can happen in parallel if the &quot;Compile independent modules in parallel&quot; option is enabled in the settings. For module-level builders, the order of invoking builders for a single target is determined by their category; for other builders, the order is undefined.</p></li><li class="list__item" id="dd07e79d_21" ><p>Caches to record the state of the compilation are saved.</p></li><li class="list__item" id="dd07e79d_22" ><p>Compilation messages reported through the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/jps/jps-builders/src/org/jetbrains/jps/incremental/CompileContext.java" id="dd07e79d_23"   data-external="true" rel="noopener noreferrer" ><code class="code " id="dd07e79d_24"  >CompileContext</code></a> API are transmitted to the IDE process and displayed in the UI (in the <span class="emphasis" id="dd07e79d_25" >Messages</span> view).</p></li><li class="list__item" id="dd07e79d_26" ><p>Post-compile tasks are executed in the IDE process.</p></li></ul></section><section class="chapter"  ><h2 id="incremental-build" data-toc="incremental-build"  >Incremental Build</h2><p id="dd07e79d_27" >To support incremental build, the build process uses several caches which are persisted between build invocations. Even if your compiler doesn't support incremental build, you still need to report correct information so that incremental build works correctly for other compilers.</p><ul class="list _ul" id="dd07e79d_28"    ><li class="list__item" id="dd07e79d_29" ><p><a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/jps/jps-builders/src/org/jetbrains/jps/builders/storage/SourceToOutputMapping.java" id="dd07e79d_30"   data-external="true" rel="noopener noreferrer" ><code class="code " id="dd07e79d_31"  >SourceToOutputMapping</code></a> is a many-to-many relationship between source files and output files (&quot;which source files were used to produce the specified output file&quot;). It's filled by calls to <code class="code " id="dd07e79d_32"  >BuildOutputConsumer.registerOutputFile()</code> and <code class="code " id="dd07e79d_33"  >ModuleLevelBuilder.OutputConsumer.registerOutputFile()</code>.</p></li></ul><p id="dd07e79d_34" >The IDE monitors the project content changes and uses the information from those caches to generate the set of dirty and deleted files for every compilation. (Dirty files need to be recompiled, and deleted files need to have their output deleted). A builder can also report additional files as dirty (e.g., if a method is deleted, the builder can report the classes using this method as dirty.) A module-level builder can add some files to the dirty scope; if this happens, and if the builder returns <code class="code " id="dd07e79d_35"  >ADDITIONAL_PASS_REQUIRED</code> from its <code class="code " id="dd07e79d_36"  >build()</code> method, another round of builder execution for the same module chunk will be started with the new dirty scope.</p><p id="dd07e79d_37" >A builder may also want to have its custom caches to store additional information to support the partial recompilation of a target (e.g., the dependencies between Java files in a module). To store this data, you can either store arbitrary files in the directory returned from <code class="code " id="dd07e79d_38"  >BuildDataManager.getDataPaths().getTargetDataRoot()</code> or use a higher-level API: <code class="code " id="dd07e79d_39"  >BuildDataManager.getStorage()</code></p><p id="dd07e79d_40" >To pass custom data between the invocation of the same builder between multiple targets, you can use <code class="code " id="dd07e79d_41"  >CompileContext.getUserData()</code> and <code class="code " id="dd07e79d_42"  >CompileContext.putUserData()</code>.</p></section><section class="chapter"  ><h2 id="services-and-extensions-in-external-builder" data-toc="services-and-extensions-in-external-builder"  >Services and Extensions in External Builder</h2><p id="dd07e79d_43" >The external builder process uses the standard Java <a href="https://docs.oracle.com/javase/8/docs/api/java/util/ServiceLoader.html" id="dd07e79d_44"   data-external="true" rel="noopener noreferrer" >services</a> mechanism to support plugins. There are several service interfaces (e.g. <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/jps/jps-builders/src/org/jetbrains/jps/incremental/BuilderService.java" id="dd07e79d_45"   data-external="true" rel="noopener noreferrer" ><code class="code " id="dd07e79d_46"  >BuilderService</code></a> which can be implemented in plugins to extend the builder functionality. An implementation of a service needs to be registered by creating the <span class="filepath" id="dd07e79d_47" >META-INF/services/$service-interface-fqn$</span> file containing the implementation class's qualified name. E.g. <code class="code " id="dd07e79d_48"  >BuilderService</code> implementations are registered in <span class="filepath" id="dd07e79d_49" >META-INF/services/org.jetbrains.jps.incremental.BuilderService</span> file. These files don't have extensions, so you need to map corresponding patterns to text files in IDE settings.</p></section><section class="chapter"  ><h2 id="registering-a-plugin-for-external-builder" data-toc="registering-a-plugin-for-external-builder"  >Registering a Plugin for External Builder</h2><p id="dd07e79d_50" >Sources of a plugin for External Builder should be put in a separate module. By convention, such a module has a name '...-jps-plugin', and its sources are placed under the <span class="filepath" id="dd07e79d_51" >jps-plugin</span> directory in the main plugin directory. Use <code class="code " id="dd07e79d_52"  >com.intellij.compileServer.plugin</code> extension point to add the plugin to the classpath of the external build process, the plugin JAR should be named <span class="filepath" id="dd07e79d_53" >$JPS_module_name$.jar</span>.  action will automatically pack the 'jps-plugin' part to a separate JAR accordingly.</p><p id="dd07e79d_55" >See <a href="https://jb.gg/ipe?extensions=com.intellij.compileServer.plugin" id="dd07e79d_56"   data-external="true" rel="noopener noreferrer" >IntelliJ Platform Explorer</a> for samples.</p></section><section class="chapter"  ><h2 id="debugging-a-plugin-for-external-builder" data-toc="debugging-a-plugin-for-external-builder"  >Debugging a Plugin for External Builder</h2><p id="dd07e79d_57" ><span class="control" id="dd07e79d_58" >If your test IDE is IntelliJ IDEA 16.0 or newer</span></p><p id="dd07e79d_59" >Switch on &quot;Debug Build Process&quot; toggle action (available via 'Find Action') in the test IDE. After that, every time compilation is run, the build process will wait for debugger connection on some (random) port and will show the port number in the status bar. In a working copy of IDE, a &quot;Remote&quot; run configuration should be created and pointed to this port. Suppose you often need to debug external builders and want to reuse the created &quot;Remote&quot; run configuration. In that case, you may fix the port number by adding the following VM option to the plugin run configuration:</p><div class="code-block" data-lang="none"         >
-Dcompiler.process.debug.port=&lt;port-number&gt;
</div><p id="dd07e79d_61" ><span class="control" id="dd07e79d_62" >If your test IDE is IntelliJ IDEA 15.0 or older</span></p><p id="dd07e79d_63" >Start IDE with your plugin with the following VM option:</p><div class="code-block" data-lang="none"         >
-Dcompiler.process.debug.port=&lt;port-number&gt;
</div><p id="dd07e79d_65" >After that, every time compilation is run in the test IDE, the build process will wait for debugger connection on this port and then proceed. In a working copy of IDE, a &quot;Remote&quot; run configuration should be created and pointed to this port. Specifying port &quot;-1&quot; will disable debugging mode.</p></section><section class="chapter"  ><h2 id="profiling-external-build-process" data-toc="profiling-external-build-process"  >Profiling External Build Process</h2><p id="dd07e79d_66" >The build process has built-in self-cpu-profiling capabilities. To enable them do the following:</p><ol class="list _decimal" id="dd07e79d_67"  type="1"  ><li class="list__item" id="dd07e79d_68" ><p>Copy <span class="filepath" id="dd07e79d_69" >$IDE_HOME$/lib/yjp-controller-api-redist.jar</span> and <span class="filepath" id="dd07e79d_70" >$IDE_HOME$/bin/yjpagent.*</span> files to <span class="filepath" id="dd07e79d_71" >$IDE_SYSTEM_DIR$/compile-server</span></p></li><li class="list__item" id="dd07e79d_72" ><p>In </p><p> add <code class="code " id="dd07e79d_74"  >-Dprofiling.mode=true</code> in <span class="control" id="dd07e79d_75" >Additional command line parameters</span></p></li><li class="list__item" id="dd07e79d_76" ><p>Make sure the automatic make is turned off</p></li></ol><p id="dd07e79d_77" >After this, every build process run should result in a CPU snapshot stored in <span class="filepath" id="dd07e79d_78" >$USER_HOME$/Snapshots</span> directory. Snapshots are named like <span class="filepath" id="dd07e79d_79" >ExternalBuild-$DATE$.snapshot</span>.</p><p id="dd07e79d_80" >Specifying <code class="code " id="dd07e79d_81"  >-Dprofiling.mode=false</code> will turn profiling off. Please capture a couple of snapshots for the situations you believe the build should work much faster than it does.</p><p id="dd07e79d_82" >Please create an issue in the issue tracker and attach generated <span class="filepath" id="dd07e79d_83" >*.snapshot</span> files to it or upload them as <a href="https://intellij-support.jetbrains.com/hc/en-us/articles/206869619" id="dd07e79d_84"   data-external="true" rel="noopener noreferrer" >described here</a> and specify links in the issue. Please also provide details about the memory and other VM settings for the build process you were using.</p></section><section class="chapter"  ><h2 id="accessing-external-build-process-logs" data-toc="accessing-external-build-process-logs"  >Accessing External Build Process' Logs</h2><p id="dd07e79d_85" >The log file is located under the directory:</p><div class="code-block" data-lang="none"         >
&lt;ide-system-directory&gt;/log/build-log
</div><p id="dd07e79d_87" >There, both <span class="filepath" id="dd07e79d_88" >build-log.log</span> and <span class="filepath" id="dd07e79d_89" >build-log.properties</span> files can be found. The <span class="filepath" id="dd07e79d_90" >build-log.properties</span> is a log4j configuration file, where the log level and desired logging categories can be adjusted. This file contains logging from all build sessions, including those from the auto-make.</p><p id="dd07e79d_91" >In IntelliJ Platform versions before version 14.1, log4j configuration was stored in <span class="filepath" id="dd07e79d_92" >build-log.xml</span>.</p></section><section class="chapter"  ><h2 id="accessing-project-model-and-configuration-from-external-build" data-toc="accessing-project-model-and-configuration-from-external-build"  >Accessing Project Model and Configuration from External Build</h2><p id="dd07e79d_93" >The project model in the External Build process is provided by JPS (<span class="emphasis" id="dd07e79d_94" >JetBrains Project System</span>). A project is represented by <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/jps/model-api/src/org/jetbrains/jps/model/JpsProject.java" id="dd07e79d_95"   data-external="true" rel="noopener noreferrer" ><code class="code " id="dd07e79d_96"  >JpsProject</code></a>, a module by <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/jps/model-api/src/org/jetbrains/jps/model/JpsProject.java" id="dd07e79d_97"   data-external="true" rel="noopener noreferrer" ><code class="code " id="dd07e79d_98"  >JpsModule</code></a>, and so on. Suppose your compiler depends on something that isn't added to the model yet (e.g., some facet settings). In that case, you need to extend the JPS model (use <code class="code " id="dd07e79d_99"  >JpsOsmorcModuleExtension</code> as a reference implementation) and provide an implementation of <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/jps/model-serialization/src/org/jetbrains/jps/model/serialization/JpsModelSerializerExtension.java" id="dd07e79d_100"   data-external="true" rel="noopener noreferrer" ><code class="code " id="dd07e79d_101"  >JpsModelSerializerExtension</code></a> to load the configuration from project files.</p><section class="chapter"  ><h3 id="implementing-builder" data-toc="implementing-builder"  >Implementing Builder</h3><p id="dd07e79d_102" >If your compiler isn't involved in the compilation of an existing <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/jps/jps-builders/src/org/jetbrains/jps/builders/BuildTarget.java" id="dd07e79d_103"   data-external="true" rel="noopener noreferrer" ><code class="code " id="dd07e79d_104"  >BuildTarget</code></a>, you need to create a new implementation of <code class="code " id="dd07e79d_105"  >BuildTarget</code> and <code class="code " id="dd07e79d_106"  >BuildTargetType</code>. Also, register an implementation of <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/java/compiler/impl/src/com/intellij/compiler/impl/BuildTargetScopeProvider.java" id="dd07e79d_107"   data-external="true" rel="noopener noreferrer" ><code class="code " id="dd07e79d_108"  >BuildTargetScopeProvider</code></a> extension on the IDE side to add required targets to the build scope. The builder implementation should extend either <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/jps/jps-builders/src/org/jetbrains/jps/incremental/TargetBuilder.java" id="dd07e79d_109"   data-external="true" rel="noopener noreferrer" ><code class="code " id="dd07e79d_110"  >TargetBuilder</code></a> or <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/jps/jps-builders/src/org/jetbrains/jps/incremental/ModuleLevelBuilder.java" id="dd07e79d_111"   data-external="true" rel="noopener noreferrer" ><code class="code " id="dd07e79d_112"  >ModuleLevelBuilder</code></a> class and should be created using <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/jps/jps-builders/src/org/jetbrains/jps/incremental/BuilderService.java" id="dd07e79d_113"   data-external="true" rel="noopener noreferrer" ><code class="code " id="dd07e79d_114"  >BuilderService</code></a> extension.</p></section></section><div class="last-modified"> Last modified: 28 九月 2022</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="build-system.html">Build System</a>   <a class="navigation-links__next" href="testing-plugins.html">Testing Overview</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/storage/help-app/v5/app.js"></script></body></html>