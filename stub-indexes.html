<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8">  <meta name="built-on" content="2022-09-29T19:15:56.3623708"><meta name="build-number" content="${buildNumber}">    <meta name="keywords" content="">  <title>Stub Indexes | IntelliJ Platform Plugin SDK</title><script id="virtual-toc-data" type="application/json">[{"id":"stub-trees","level":0,"title":"Stub Trees","anchor":"#stub-trees"},{"id":"stub-indexes","level":0,"title":"Stub Indexes","anchor":"#stub-indexes"},{"id":"related-forum-discussions","level":0,"title":"Related Forum Discussions","anchor":"#related-forum-discussions"}]</script>   <link href="https://resources.jetbrains.com/storage/help-app/v5/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- Open Graph --><meta property="og:title" content="Stub Indexes | IntelliJ Platform Plugin SDK"/><meta property="og:description" content=""/><meta property="og:image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"/><meta property="og:site_name" content="IntelliJ Platform Plugin SDK Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="https://plugins.jetbrains.com/docs/intellij/stub-indexes.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@JBPlatform"><meta name="twitter:title" content="Stub Indexes | IntelliJ Platform Plugin SDK"><meta name="twitter:description" content=""><meta name="twitter:creator" content="@JBPlatform"><meta name="twitter:image:src" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "https://plugins.jetbrains.com/docs/intellij/stub-indexes.html#webpage", "url": "https://plugins.jetbrains.com/docs/intellij/stub-indexes.html", "name": "Stub Indexes | IntelliJ Platform Plugin SDK", "description": "", "image": "https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "https://plugins.jetbrains.com/docs/intellij/#website", "url": "https://plugins.jetbrains.com/docs/intellij/", "name": "IntelliJ Platform Plugin SDK Help" }</script><!-- End Schema.org --></head>    <body data-id="stub_indexes.md" data-main-title="Stub Indexes" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Part IV — PSI///indexing_and_psi_stubs.md|Indexing and PSI Stubs"  data-edit-url="https://github.com/JetBrains/intellij-sdk-docs/edit/main/topics/basics/indexing_and_psi_stubs/stub_indexes.md"  >  <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>IntelliJ Platform Plugin SDK  Help</h3><div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select class="select _shortcuts" height="1" id="switch-shortcuts">      </select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="stub_indexes.md" id="stub_indexes.md"  >Stub Indexes</h1><section class="chapter"  ><h2 id="stub-trees" data-toc="stub-trees"  >Stub Trees</h2><p id="28a52ee4_97" >A stub tree is a subset of the PSI tree for a file; it is stored in a compact serialized binary format. The PSI tree for a file can be backed either by the AST (built by parsing the file) or by the stub tree deserialized from disk. Switching between the two is transparent.</p><p id="28a52ee4_98" >The stub tree contains only a subset of the nodes. Typically, it contains only the nodes needed to resolve the declarations contained in this file from external files. Trying to access any node that is not part of the stub tree or perform any operation that cannot be satisfied by the stub tree, e.g., accessing the text of a PSI element, causes file parsing to switch from the PSI to AST backing.</p><p id="28a52ee4_99" >Each stub in the stub tree is simply a bean class with no behavior. A stub stores a subset of the corresponding PSI element's state, like the element's name, modifier flags like public or final, etc. The stub also holds a pointer to its parent in the tree and a list of its children's stubs.</p><p id="28a52ee4_100" >To support stubs for your custom language, you first need to decide which of your PSI tree elements should be stored as stubs. Typically, you need to have stubs for things like methods or fields visible from other files. You usually don't need to have stubs for things like statements or local variables, which are not visible externally.</p><section class="chapter"  ><h3 id="implementation" data-toc="implementation"  >Implementation</h3><p id="28a52ee4_101" >The following steps need to be performed only once for each language that supports stubs:</p><ul class="list _ul" id="28a52ee4_102"    ><li class="list__item" id="28a52ee4_103" ><p>Change the file element type for your language (the element type that you return from <code class="code " id="28a52ee4_104"  >ParserDefinition.getFileNodeType()</code>) to a class that extends <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-impl/src/com/intellij/psi/tree/IStubFileElementType.java" id="28a52ee4_105"   data-external="true" rel="noopener noreferrer" ><code class="code " id="28a52ee4_106"  >IStubFileElementType</code></a>.</p></li><li class="list__item" id="28a52ee4_107" ><p>In your <span class="filepath" id="28a52ee4_108" ><a href="plugin-configuration-file.html" id="28a52ee4_109" data-tooltip="Plugin configuration file contains all the information about the plugin, as well as all registered extensions, actions, listeners, etc."  >plugin.xml</a></span>, define the <code class="code " id="28a52ee4_110"  >com.intellij.stubElementTypeHolder</code> extension and specify the interface which contains the <code class="code " id="28a52ee4_111"  >IElementType</code> constants used by your language's parser. Define common <code class="code " id="28a52ee4_112"  >externalIdPrefix</code> to be used for all stub element types (see <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/stubs/StubElementTypeHolderEP.java" id="28a52ee4_113"   data-external="true" rel="noopener noreferrer" ><code class="code " id="28a52ee4_114"  >StubElementTypeHolderEP</code></a> docs for important requirements).</p></li></ul><p id="28a52ee4_115" ><span class="control" id="28a52ee4_116" >Example</span>: <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/java/java-psi-impl/src/com/intellij/psi/impl/java/stubs/JavaStubElementTypes.java" id="28a52ee4_117"   data-external="true" rel="noopener noreferrer" ><code class="code " id="28a52ee4_118"  >JavaStubElementTypes</code></a> registered in <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/java/java-psi-impl/src/META-INF/JavaPsiPlugin.xml" id="28a52ee4_119"   data-external="true" rel="noopener noreferrer" ><code class="code " id="28a52ee4_120"  >JavaPsiPlugin.xml</code></a></p><p id="28a52ee4_121" >For each element type that you want to store in the stub tree, you need to perform the following steps:</p><ul class="list _ul" id="28a52ee4_122"    ><li class="list__item" id="28a52ee4_123" ><p>Define an interface for the stub, derived from the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/stubs/StubElement.java" id="28a52ee4_124"   data-external="true" rel="noopener noreferrer" ><code class="code " id="28a52ee4_125"  >StubElement</code></a> interface (<a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/plugins/properties/properties-psi-api/src/com/intellij/lang/properties/psi/PropertyStub.java" id="28a52ee4_126"   data-external="true" rel="noopener noreferrer" >example</a>).</p></li><li class="list__item" id="28a52ee4_127" ><p>Provide an implementation for the interface (<a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/plugins/properties/properties-psi-impl/src/com/intellij/lang/properties/psi/impl/PropertyStubImpl.java" id="28a52ee4_128"   data-external="true" rel="noopener noreferrer" >example</a>).</p></li><li class="list__item" id="28a52ee4_129" ><p>Make sure the interface for the PSI element extends <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/StubBasedPsiElement.java" id="28a52ee4_130"   data-external="true" rel="noopener noreferrer" ><code class="code " id="28a52ee4_131"  >StubBasedPsiElement</code></a> parameterized by the type of the stub interface (<a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/plugins/properties/properties-psi-api/src/com/intellij/lang/properties/psi/Property.java" id="28a52ee4_132"   data-external="true" rel="noopener noreferrer" >example</a>).</p></li><li class="list__item" id="28a52ee4_133" ><p>Make sure the implementation class for the PSI element extends <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-impl/src/com/intellij/extapi/psi/StubBasedPsiElementBase.java" id="28a52ee4_134"   data-external="true" rel="noopener noreferrer" ><code class="code " id="28a52ee4_135"  >StubBasedPsiElementBase</code></a> parameterized by the type of the stub interface (<a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/plugins/properties/properties-psi-impl/src/com/intellij/lang/properties/psi/impl/PropertyImpl.java" id="28a52ee4_136"   data-external="true" rel="noopener noreferrer" >example</a>). Provide both a constructor that accepts an <code class="code " id="28a52ee4_137"  >ASTNode</code> and a constructor that accepts a stub.</p></li><li class="list__item" id="28a52ee4_138" ><p>Create a class that implements <code class="code " id="28a52ee4_139"  >IStubElementType</code> and is parameterized with the stub interface and the actual PSI element interface (<a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/plugins/properties/properties-psi-impl/src/com/intellij/lang/properties/parsing/PropertyStubElementType.java" id="28a52ee4_140"   data-external="true" rel="noopener noreferrer" >example</a>). Implement the <code class="code " id="28a52ee4_141"  >createPsi()</code> and <code class="code " id="28a52ee4_142"  >createStub()</code> methods for creating PSI from a stub and vice versa. Implement the <code class="code " id="28a52ee4_143"  >serialize()</code> and <code class="code " id="28a52ee4_144"  >deserialize()</code> methods for storing the data in a binary stream.</p></li><li class="list__item" id="28a52ee4_145" ><p>Use the class implementing <code class="code " id="28a52ee4_146"  >IStubElementType</code> as the element type constant when parsing (<a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/plugins/properties/properties-psi-impl/src/com/intellij/lang/properties/parsing/PropertiesElementTypes.java" id="28a52ee4_147"   data-external="true" rel="noopener noreferrer" >example</a>).</p></li><li class="list__item" id="28a52ee4_148" ><p>Make sure all methods in the PSI element interface access the stub data rather than the PSI tree when appropriate (<a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/plugins/properties/properties-psi-impl/src/com/intellij/lang/properties/psi/impl/PropertyImpl.java" id="28a52ee4_149"   data-external="true" rel="noopener noreferrer" >example: <code class="code " id="28a52ee4_150"  >Property.getKey()</code> implementation</a>).</p></li></ul><aside data-type="tip" class="prompt" data-title="" id="28a52ee4_151" ><p id="28a52ee4_152" >If you use <a href="https://github.com/JetBrains/Grammar-Kit" id="28a52ee4_153"   data-external="true" rel="noopener noreferrer" >Grammar-Kit</a> to generate your language PSI, see the <a href="https://github.com/JetBrains/Grammar-Kit/blob/master/HOWTO.md#35-stub-indices-support" id="28a52ee4_154"   data-external="true" rel="noopener noreferrer" >Stub indices support</a> section for instructions on integrating your grammar with stubs.</p></aside><p id="28a52ee4_155" >By default, if a PSI element extends <code class="code " id="28a52ee4_156"  >StubBasedPsiElement</code>, all elements of that type will be stored in the stub tree. If you need more precise control over which elements are stored, override <code class="code " id="28a52ee4_157"  >IStubElementType.shouldCreateStub()</code> and return <code class="code " id="28a52ee4_158"  >false</code> for elements that should not be included in the stub tree. The exclusion is not recursive: if some elements of the element for which you returned false are also stub-based PSI elements, they will be included in the stub tree.</p></section><section class="chapter"  ><h3 id="serializing-data" data-toc="serializing-data"  >Serializing Data</h3><p id="28a52ee4_159" >For serializing string data, e.g. element names, in stubs, we recommend to use <code class="code " id="28a52ee4_160"  >StubOutputStream.writeName()</code> and <code class="code " id="28a52ee4_161"  >StubInputStream.readName()</code> methods. These methods ensure that each unique identifier is stored only once in the data stream. This reduces the size of the serialized stub tree data. See also <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/util/src/com/intellij/util/io/DataInputOutputUtil.java" id="28a52ee4_162"   data-external="true" rel="noopener noreferrer" ><code class="code " id="28a52ee4_163"  >DataInputOutputUtil</code></a>.</p><p id="28a52ee4_164" >If you need to change the stored binary format for the stubs (for example, if you want to store some additional data or some new elements), make sure you advance the stub version returned from <code class="code " id="28a52ee4_165"  >IStubFileElementType.getStubVersion()</code> for your language. This will cause the stubs and <a href="#stub-indexes" id="28a52ee4_166" data-tooltip="When building the stub tree, you can, at the same time, put some data about the stub elements into a number of indexes, which then can be used to find the PSI elements by the corresponding key. Unlike file-based indexes, stub indexes do not support storing custom data as values; the…"  >Stub Indexes</a> to be rebuilt, and will avoid mismatches between the stored data format and the code trying to load it.</p><p id="28a52ee4_167" >It's essential to ensure that all information stored in the stub tree depends only on the contents of the file for which stubs are being built, and does not depend on any external files. Otherwise, the stub tree will not be rebuilt when external dependency changes, and you will have stale and incorrect data in the stub tree.</p><aside data-type="tip" class="prompt" data-title="" id="28a52ee4_168" ><p id="28a52ee4_169" >Please see also <a href="indexing-and-psi-stubs.html#improving-indexing-performance" id="28a52ee4_170" data-tooltip="Indexing performance metrics in JSON format are generated in logs directory (see sandbox directory for development instance) in 2020.2 and later. These are additionally available in HTML format starting with 2021.1."  >Improving Indexing Performance</a>.</p></aside></section></section><section class="chapter"  ><h2 id="stub-indexes" data-toc="stub-indexes"  >Stub Indexes</h2><p id="28a52ee4_171" >When building the stub tree, you can, at the same time, put some data about the stub elements into a number of indexes, which then can be used to find the PSI elements by the corresponding key. Unlike file-based indexes, stub indexes do not support storing custom data as values; the value is always a PSI element. Keys in stub indexes are typically strings (such as class names); other data types are also supported if desired.</p><p id="28a52ee4_172" >A stub index is a class which extends <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/indexing-api/src/com/intellij/psi/stubs/AbstractStubIndex.java" id="28a52ee4_173"   data-external="true" rel="noopener noreferrer" ><code class="code " id="28a52ee4_174"  >AbstractStubIndex</code></a>. In the most common case, when the key type is <code class="code " id="28a52ee4_175"  >String</code>, you use a more specific base class, namely <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/indexing-api/src/com/intellij/psi/stubs/StringStubIndexExtension.java" id="28a52ee4_176"   data-external="true" rel="noopener noreferrer" ><code class="code " id="28a52ee4_177"  >StringStubIndexExtension</code></a>. Stub index implementation classes are registered in the <code class="code " id="28a52ee4_178"  >com.intellij.stubIndex</code> extension point.</p><p id="28a52ee4_179" >To put data into an index, you implement the method <code class="code " id="28a52ee4_180"  >IStubElementType.indexStub()</code> (<a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/java/java-psi-impl/src/com/intellij/psi/impl/java/stubs/JavaClassElementType.java" id="28a52ee4_181"   data-external="true" rel="noopener noreferrer" >example: <code class="code " id="28a52ee4_182"  >JavaClassElementType.indexStub()</code></a>). This method accepts an <code class="code " id="28a52ee4_183"  >IndexSink</code> as a parameter and puts in the index ID and the key for each index in which the element should be stored.</p><p id="28a52ee4_184" >To access the data from an index, the following two methods are used:</p><ul class="list _ul" id="28a52ee4_185"    ><li class="list__item" id="28a52ee4_186" ><p><code class="code " id="28a52ee4_187"  >AbstractStubIndex.getAllKeys()</code> returns the list of all keys in the specified index for the specified project (for example, the list of all class names found in the project).</p></li><li class="list__item" id="28a52ee4_188" ><p><code class="code " id="28a52ee4_189"  >AbstractStubIndex.get()</code> returns the collection of PSI elements corresponding to a certain key (for example, classes with the specified short name) in the specified scope.</p></li></ul></section><section class="chapter"  ><h2 id="related-forum-discussions" data-toc="related-forum-discussions"  >Related Forum Discussions</h2><ul class="list _ul" id="28a52ee4_190"    ><li class="list__item" id="28a52ee4_191" ><p><a href="https://intellij-support.jetbrains.com/hc/en-us/community/posts/206121959-Lifecycle-of-stub-creation/comments/206143885" id="28a52ee4_192"   data-external="true" rel="noopener noreferrer" >Lifecycle of stub creation</a></p></li></ul></section><div class="last-modified"> Last modified: 29 九月 2022</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="file-based-indexes.html">File-Based Indexes</a>   <a class="navigation-links__next" href="element-patterns.html">Element Patterns</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/storage/help-app/v5/app.js"></script></body></html>