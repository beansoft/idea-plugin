<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8">  <meta name="built-on" content="2022-09-29T19:15:56.8852641"><meta name="build-number" content="${buildNumber}">    <meta name="keywords" content="">  <title>Modifying the PSI | IntelliJ Platform Plugin SDK</title><script id="virtual-toc-data" type="application/json">[{"id":"creating-the-new-psi","level":0,"title":"Creating the New PSI","anchor":"#creating-the-new-psi"},{"id":"maintaining-tree-structure-consistency","level":0,"title":"Maintaining Tree Structure Consistency","anchor":"#maintaining-tree-structure-consistency"},{"id":"whitespaces-and-imports","level":0,"title":"Whitespaces and Imports","anchor":"#whitespaces-and-imports"},{"id":"combining-psi-and-document-modifications","level":0,"title":"Combining PSI and Document Modifications","anchor":"#combining-psi-and-document-modifications"}]</script>   <link href="https://resources.jetbrains.com/storage/help-app/v5/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- Open Graph --><meta property="og:title" content="Modifying the PSI | IntelliJ Platform Plugin SDK"/><meta property="og:description" content=""/><meta property="og:image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"/><meta property="og:site_name" content="IntelliJ Platform Plugin SDK Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="https://plugins.jetbrains.com/docs/intellij/modifying-psi.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@JBPlatform"><meta name="twitter:title" content="Modifying the PSI | IntelliJ Platform Plugin SDK"><meta name="twitter:description" content=""><meta name="twitter:creator" content="@JBPlatform"><meta name="twitter:image:src" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "https://plugins.jetbrains.com/docs/intellij/modifying-psi.html#webpage", "url": "https://plugins.jetbrains.com/docs/intellij/modifying-psi.html", "name": "Modifying the PSI | IntelliJ Platform Plugin SDK", "description": "", "image": "https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "https://plugins.jetbrains.com/docs/intellij/#website", "url": "https://plugins.jetbrains.com/docs/intellij/", "name": "IntelliJ Platform Plugin SDK Help" }</script><!-- End Schema.org --></head>    <body data-id="modifying_psi.md" data-main-title="Modifying the PSI" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Part IV — PSI"  data-edit-url="https://github.com/JetBrains/intellij-sdk-docs/edit/main/topics/basics/architectural_overview/modifying_psi.md"  >  <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>IntelliJ Platform Plugin SDK  Help</h3><div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select class="select _shortcuts" height="1" id="switch-shortcuts">      </select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="modifying_psi.md" id="modifying_psi.md"  >Modifying the PSI</h1><p id="4cf613d5_63" >The PSI is a read/write representation of the source code as a tree of elements corresponding to a source file's structure. You can modify the PSI by <span class="emphasis" id="4cf613d5_64" >adding</span>, <span class="emphasis" id="4cf613d5_65" >replacing</span>, and <span class="emphasis" id="4cf613d5_66" >deleting</span> PSI elements.</p><p id="4cf613d5_67" >To perform these operations, you use methods such as <code class="code " id="4cf613d5_68"  >PsiElement.add()</code>, <code class="code " id="4cf613d5_69"  >PsiElement.delete()</code>, and <code class="code " id="4cf613d5_70"  >PsiElement.replace()</code>, as well as other methods defined in the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/PsiElement.java" id="4cf613d5_71"   data-external="true" rel="noopener noreferrer" ><code class="code " id="4cf613d5_72"  >PsiElement</code></a> interface that let you process multiple elements in a single operation, or to specify the exact location in the tree where an element needs to be added.</p><p id="4cf613d5_73" >Like document operations, PSI modifications need to be wrapped in a write action and in command (and can only be performed in the event dispatch thread). See <a href="documents.html#what-are-the-rules-of-working-with-documents" id="4cf613d5_74" data-tooltip="The general read/write action rules are in effect (see ). Besides, any operations which modify the contents of the document must be wrapped in a command (CommandProcessor.executeCommand()). executeCommand() calls can be nested, and the outermost executeCommand() call is added to the…"  >the Documents article</a> for more information on commands and write actions.</p><section class="chapter"  ><h2 id="creating-the-new-psi" data-toc="creating-the-new-psi"  >Creating the New PSI</h2><p id="4cf613d5_75" >The PSI elements to add to the tree or replace existing PSI elements are usually <span class="emphasis" id="4cf613d5_76" >created from text</span>. In the most general case, you use the <code class="code " id="4cf613d5_77"  >createFileFromText()</code> method of <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/PsiFileFactory.java" id="4cf613d5_78"   data-external="true" rel="noopener noreferrer" ><code class="code " id="4cf613d5_79"  >PsiFileFactory</code></a> to create a new file that contains the code construct which you need to add to the tree or to use as a replacement for an existing element, traverse the resulting tree to locate the specific part that you need, and then pass that element to <code class="code " id="4cf613d5_80"  >add()</code> or <code class="code " id="4cf613d5_81"  >replace()</code>. See also <a href="psi-files.html#how-do-i-create-a-psi-file" id="4cf613d5_82" data-tooltip="The PsiFileFactory createFileFromText() method creates an in-memory PSI file with the specified contents."  >How do I create a PSI file?</a>.</p><p id="4cf613d5_83" >Most languages provide factory methods that let you create specific code constructs more easily. For example, the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/java/java-psi-api/src/com/intellij/psi/PsiJavaParserFacade.java" id="4cf613d5_84"   data-external="true" rel="noopener noreferrer" ><code class="code " id="4cf613d5_85"  >PsiJavaParserFacade</code></a> class contains methods such as <code class="code " id="4cf613d5_86"  >createMethodFromText()</code>, which creates a Java method from the given text.</p><p id="4cf613d5_87" >When you're implementing refactorings, <a href="code-intentions.html" id="4cf613d5_88" data-tooltip="This topic describes the conditional_operator_intention, a sample plugin that adds a new intention action to the IDE Intentions list. In addition, the sample plugin contains a JUnit-based test."  >intentions</a>, or inspection <a href="code-inspections-and-intentions.html" id="4cf613d5_89" data-tooltip="The code inspections for custom languages use the same API as all other code inspections, based on the LocalInspectionTool class."  >quickfixes</a> that work with existing code, the text that you pass to the various <code class="code " id="4cf613d5_90"  >createFromText()</code> methods will combine hard-coded fragments and fragments of code taken from the existing file. For small code fragments (individual identifiers), you can simply append the text from the existing code to the text of the code fragment you are building. In that case, you need to make sure that the resulting text is syntactically correct. Otherwise, the <code class="code " id="4cf613d5_91"  >createFromText()</code> method will throw an exception.</p><p id="4cf613d5_92" >For larger code fragments, it's best to perform the modification in several steps:</p><ul class="list _ul" id="4cf613d5_93"    ><li class="list__item" id="4cf613d5_94" ><p>create a replacement tree fragment from the text, leaving placeholders for the user code fragments;</p></li><li class="list__item" id="4cf613d5_95" ><p>replace the placeholders with the user code fragments;</p></li><li class="list__item" id="4cf613d5_96" ><p>replace the element in the original source file with the replacement tree.</p></li></ul><p id="4cf613d5_97" >This ensures that the user code's formatting is preserved and that the modification does not introduce any unwanted whitespace changes. Just as everywhere else in the IntelliJ Platform API, the text passed to <code class="code " id="4cf613d5_98"  >createFileFromText()</code> and other <code class="code " id="4cf613d5_99"  >createFromText()</code> methods must use only <code class="code " id="4cf613d5_100"  >\n</code> as line separators.</p><p id="4cf613d5_101" >As an example of this approach, see the quickfix in the <code class="code " id="4cf613d5_102"  >ComparingReferencesInspection</code> <a href="code-inspections.html" id="4cf613d5_103" data-tooltip="The IntelliJ Platform provides tools designed for static code analysis called code inspections, which help the user maintain and clean up code without actually executing it. Custom code inspections can be implemented as IntelliJ Platform plugins. Examples of the plugin approach are…"  >example</a>:</p><div class="code-block" data-lang="java"         >
// binaryExpression holds a PSI expression of the form &quot;x == y&quot;, which needs to be replaced with &quot;x.equals(y)&quot;
PsiBinaryExpression binaryExpression = (PsiBinaryExpression) descriptor.getPsiElement();
IElementType opSign = binaryExpression.getOperationTokenType();
PsiExpression lExpr = binaryExpression.getLOperand();
PsiExpression rExpr = binaryExpression.getROperand();

// Step 1: Create a replacement fragment from text, with &quot;a&quot; and &quot;b&quot; as placeholders
PsiElementFactory factory = JavaPsiFacade.getInstance(project).getElementFactory();
PsiMethodCallExpression equalsCall =
    (PsiMethodCallExpression) factory.createExpressionFromText(&quot;a.equals(b)&quot;, null);

// Step 2: replace &quot;a&quot; and &quot;b&quot; with elements from the original file
equalsCall.getMethodExpression().getQualifierExpression().replace(lExpr);
equalsCall.getArgumentList().getExpressions()[0].replace(rExpr);

// Step 3: replace a larger element in the original file with the replacement tree
PsiExpression result = (PsiExpression) binaryExpression.replace(equalsCall);
</div></section><section class="chapter"  ><h2 id="maintaining-tree-structure-consistency" data-toc="maintaining-tree-structure-consistency"  >Maintaining Tree Structure Consistency</h2><p id="4cf613d5_105" >The PSI modification methods do not restrict you in the way you can build the resulting tree structure. For example, when working with a Java class, you can add a <code class="code " id="4cf613d5_106"  >for</code> statement as a direct child of a <code class="code " id="4cf613d5_107"  >PsiMethod</code> element, even though the Java parser will never produce such a structure (the <code class="code " id="4cf613d5_108"  >for</code> statement will always be a child of the <code class="code " id="4cf613d5_109"  >PsiCodeBlock</code>) representing the method body. Modifications that produce incorrect tree structures may appear to work, but they will lead to problems and exceptions later. Therefore, you always need to ensure that the structure you built with PSI modification operations is the same as what the parser would produce when parsing the code that you've created.</p><p id="4cf613d5_110" >To make sure you're not introducing inconsistencies, you can call <code class="code " id="4cf613d5_111"  >PsiTestUtil.checkFileStructure()</code> in the tests for your action that modifies the PSI. This method ensures that the structure you've built is the same as what the parser produces.</p></section><section class="chapter"  ><h2 id="whitespaces-and-imports" data-toc="whitespaces-and-imports"  >Whitespaces and Imports</h2><p id="4cf613d5_112" >When working with PSI modification functions, you should never create individual whitespace nodes (spaces or line breaks) from the text. Instead, all whitespace modifications are performed by the formatter, which follows the code style settings selected by the user. Formatting is automatically performed at the end of every command, and if you need, you can also perform it manually using the <code class="code " id="4cf613d5_113"  >reformat(PsiElement)</code> method in the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/codeStyle/CodeStyleManager.java" id="4cf613d5_114"   data-external="true" rel="noopener noreferrer" ><code class="code " id="4cf613d5_115"  >CodeStyleManager</code></a> class.</p><p id="4cf613d5_116" >Also, when working with Java code (or with code in other languages with a similar import mechanism such as Groovy or Python), you should never create imports manually. Instead, you should insert fully-qualified names into the code you're generating, and then call the <code class="code " id="4cf613d5_117"  >shortenClassReferences()</code> method in the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/java/java-psi-api/src/com/intellij/psi/codeStyle/JavaCodeStyleManager.java" id="4cf613d5_118"   data-external="true" rel="noopener noreferrer" ><code class="code " id="4cf613d5_119"  >JavaCodeStyleManager</code></a> (or the equivalent API for the language you're working with). This ensures that the imports are created according to the user's code style settings and inserted into the file's correct place.</p></section><section class="chapter"  ><h2 id="combining-psi-and-document-modifications" data-toc="combining-psi-and-document-modifications"  >Combining PSI and Document Modifications</h2><p id="4cf613d5_120" >In some cases, you need to perform a PSI modification and then to perform an operation on the document you've just modified through the PSI (for example, start a <a href="live-templates.html" id="4cf613d5_121" data-tooltip="Live Templates are customizable rules that allow developers to abbreviate repetitive text patterns or surround code fragments with repetitive constructs in the editor."  >live template</a>). To complete the PSI-based post-processing (such as formatting) and commit the changes to the document, call <code class="code " id="4cf613d5_122"  >doPostponedOperationsAndUnblockDocument()</code> on <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/PsiDocumentManager.java" id="4cf613d5_123"   data-external="true" rel="noopener noreferrer" ><code class="code " id="4cf613d5_124"  >PsiDocumentManager</code></a> instance.</p></section><div class="last-modified"> Last modified: 29 九月 2022</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="psi-references.html">PSI References</a>   <a class="navigation-links__next" href="psi-cookbook.html">PSI Cookbook</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/storage/help-app/v5/app.js"></script></body></html>