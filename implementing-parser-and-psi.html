<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8">  <meta name="built-on" content="2022-09-25T22:17:41.2976569"><meta name="build-number" content="${buildNumber}">    <meta name="keywords" content="">  <title>Implementing Parser and PSI | IntelliJ Platform Plugin SDK</title><script id="virtual-toc-data" type="application/json">[{"id":"parser-implementation","level":0,"title":"Parser Implementation","anchor":"#parser-implementation"},{"id":"psi-implementation","level":0,"title":"PSI Implementation","anchor":"#psi-implementation"}]</script>   <link href="https://resources.jetbrains.com/storage/help-app/v5/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- Open Graph --><meta property="og:title" content="Implementing Parser and PSI | IntelliJ Platform Plugin SDK"/><meta property="og:description" content=""/><meta property="og:image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"/><meta property="og:site_name" content="IntelliJ Platform Plugin SDK Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="https://plugins.jetbrains.com/docs/intellij/implementing-parser-and-psi.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@JBPlatform"><meta name="twitter:title" content="Implementing Parser and PSI | IntelliJ Platform Plugin SDK"><meta name="twitter:description" content=""><meta name="twitter:creator" content="@JBPlatform"><meta name="twitter:image:src" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "https://plugins.jetbrains.com/docs/intellij/implementing-parser-and-psi.html#webpage", "url": "https://plugins.jetbrains.com/docs/intellij/implementing-parser-and-psi.html", "name": "Implementing Parser and PSI | IntelliJ Platform Plugin SDK", "description": "", "image": "https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "https://plugins.jetbrains.com/docs/intellij/#website", "url": "https://plugins.jetbrains.com/docs/intellij/", "name": "IntelliJ Platform Plugin SDK Help" }</script><!-- End Schema.org --></head>    <body data-id="implementing_parser_and_psi.md" data-main-title="Implementing Parser and PSI" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Part VII — Custom Languages///custom_language_support.md|Custom Language Support"  data-edit-url="https://github.com/JetBrains/intellij-sdk-docs/edit/main/topics/reference_guide/custom_language_support/implementing_parser_and_psi.md"  >  <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>IntelliJ Platform Plugin SDK  Help</h3><div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select class="select _shortcuts" height="1" id="switch-shortcuts">      </select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="implementing_parser_and_psi.md" id="implementing_parser_and_psi.md"  >Implementing Parser and PSI</h1><p id="6121e043_1" >Parsing files in IntelliJ Platform is a two-step process.</p><p id="6121e043_2" >First, an abstract syntax tree (AST) is built, defining the structure of the program. AST nodes are created internally by the IDE and are represented by instances of the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/lang/ASTNode.java" id="6121e043_3"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_4"  >ASTNode</code></a> class. Each AST node has an associated element type <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/tree/IElementType.java" id="6121e043_5"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_6"  >IElementType</code></a> instance, and the element types are defined by the language plugin. The AST tree's top-level node for a file needs to have a special element type, which extends the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/tree/IFileElementType.java" id="6121e043_7"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_8"  >IFileElementType</code></a> class.</p><p id="6121e043_9" >The AST nodes have a direct mapping to text ranges in the underlying document. The bottom-most nodes of the AST match individual tokens returned by the <a href="implementing-lexer.html" id="6121e043_10" data-tooltip="A Lexer defines how a file's contents are broken into tokens."  >lexer</a>, and higher-level nodes match multiple-token fragments. Operations performed on nodes of the AST tree, such as inserting, removing, reordering nodes, and so on, are immediately reflected as changes to the underlying document's text.</p><p id="6121e043_11" >Second, a PSI, or Program Structure Interface, tree is built on top of the AST, adding semantics and methods for manipulating specific language constructs. Nodes of the PSI tree are represented by classes implementing the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/PsiElement.java" id="6121e043_12"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_13"  >PsiElement</code></a> interface and are created by the language plugin in the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/lang/ParserDefinition.java" id="6121e043_14"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_15"  >ParserDefinition.createElement()</code></a> method. The top-level node of the PSI tree for a file needs to implement the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/PsiFile.java" id="6121e043_16"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_17"  >PsiFile</code></a> interface and is created in the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/lang/ParserDefinition.java" id="6121e043_18"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_19"  >ParserDefinition.createFile()</code></a> method.</p><p id="6121e043_20" ><span class="control" id="6121e043_21" >Example</span>: <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/plugins/properties/properties-psi-impl/src/com/intellij/lang/properties/parsing/PropertiesParserDefinition.java" id="6121e043_22"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_23"  >ParserDefinition</code></a> for <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/plugins/properties" id="6121e043_24"   data-external="true" rel="noopener noreferrer" >Properties language plugin</a></p><aside data-type="tip" class="prompt" data-title="" id="6121e043_25" ><p id="6121e043_26" >To avoid unnecessary classloading when initializing the <code class="code " id="6121e043_27"  >ParserDefinition</code> extension point implementation, all <code class="code " id="6121e043_28"  >TokenSet</code> return values should use constants from dedicated <code class="code " id="6121e043_29"  >$Language$TokenSets</code> class.</p></aside><p id="6121e043_30" >The PSI's lifecycle is described in more detail in <a href="fundamentals.html" id="6121e043_31" data-tooltip="本节介绍 IntelliJ Platform的低级别基础构建块:"  >Fundamentals</a>.</p><p id="6121e043_32" >The base classes for the PSI implementation, including <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-impl/src/com/intellij/extapi/psi/PsiFileBase.java" id="6121e043_33"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_34"  >PsiFileBase</code></a>, the base implementation of <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/PsiFile.java" id="6121e043_35"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_36"  >PsiFile</code></a>, and <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-impl/src/com/intellij/extapi/psi/ASTWrapperPsiElement.java" id="6121e043_37"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_38"  >ASTWrapperPsiElement</code></a>, the base implementation of <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/PsiElement.java" id="6121e043_39"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_40"  >PsiElement</code></a>, are provided by IntelliJ Platform.</p><section class="chapter"  ><h2 id="parser-implementation" data-toc="parser-implementation"  >Parser Implementation</h2><p id="6121e043_41" >While coding parser manually is quite possible, we highly recommend generating parser and corresponding PSI classes from grammars using <a href="https://plugins.jetbrains.com/plugin/6606-grammar-kit" id="6121e043_42"   data-external="true" rel="noopener noreferrer" >Grammar-Kit</a> plugin. Besides code generation, it provides various features for editing grammar files: syntax highlighting, quick navigation, refactorings, etc. as well as integration with Gradle via <a href="tools-gradle-grammar-kit-plugin.html" id="6121e043_43" data-tooltip="The Gradle Grammar-Kit Plugin automates generating lexers and parsers to support building custom language plugins for IntelliJ-based IDEs when using Grammar-Kit."  >Gradle Grammar-Kit Plugin</a>. The Grammar-Kit plugin is built using its own engine; its source code and documentation can be found on <a href="https://github.com/JetBrains/Grammar-Kit" id="6121e043_44"   data-external="true" rel="noopener noreferrer" >GitHub</a>.</p><p id="6121e043_45" >For re-using existing ANTLRv4 grammars, see <a href="https://github.com/antlr/antlr4-intellij-adaptor" id="6121e043_46"   data-external="true" rel="noopener noreferrer" >antlr4-intellij-adaptor</a> library.</p><p id="6121e043_47" >The language plugin provides the parser implementation as an implementation of the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/lang/PsiParser.java" id="6121e043_48"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_49"  >PsiParser</code></a> interface, returned from <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/lang/ParserDefinition.java" id="6121e043_50"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_51"  >ParserDefinition.createParser()</code></a>. The parser receives an instance of the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/lang/PsiBuilder.java" id="6121e043_52"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_53"  >PsiBuilder</code></a> class, which is used to get the stream of tokens from the lexer and to hold the intermediate state of the AST being built. The parser must process all tokens returned by the lexer up to the end of the stream, in other words, until <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/lang/PsiBuilder.java" id="6121e043_54"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_55"  >PsiBuilder.getTokenType()</code></a> returns <code class="code " id="6121e043_56"  >null</code>, even if the tokens are not valid according to the language syntax.</p><p id="6121e043_57" ><span class="control" id="6121e043_58" >Examples</span>:</p><ul class="list _ul" id="6121e043_59"    ><li class="list__item" id="6121e043_60" ><p><a href="grammar-and-parser.html" id="6121e043_61" data-tooltip="Reference: ,"  >Custom Language Support Tutorial: Grammar and Parser</a></p></li><li class="list__item" id="6121e043_62" ><p><a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/plugins/properties/properties-psi-impl/src/com/intellij/lang/properties/parsing/PropertiesParser.java" id="6121e043_63"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_64"  >PsiParser</code></a> implementation for <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/plugins/properties/properties-psi-impl/src/com/intellij/lang/properties" id="6121e043_65"   data-external="true" rel="noopener noreferrer" >Properties language plugin</a>.</p></li></ul><p id="6121e043_66" >The parser works by setting pairs of markers (<a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/lang/PsiBuilder.java" id="6121e043_67"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_68"  >PsiBuilder.Marker</code></a> instances) within the stream of tokens received from the lexer. Each pair of markers defines the range of lexer tokens for a single node in the AST tree. If a pair of markers is nested in another pair (starts after its start and ends before its end), it becomes the outer pair's child node.</p><p id="6121e043_69" >The element type for the marker pair and for the AST node created from it is specified when the end marker is set, which is done by making the call to <code class="code " id="6121e043_70"  >PsiBuilder.Marker.done()</code>. Also, it is possible to drop a start marker before its end marker has been set. The <code class="code " id="6121e043_71"  >drop()</code> method drops only a single start marker without affecting any markers added after it, and the <code class="code " id="6121e043_72"  >rollbackTo()</code> method drops the start marker and all markers added after it and reverts the lexer position to the start marker. These methods can be used to implement lookahead when parsing.</p><p id="6121e043_73" >The method <code class="code " id="6121e043_74"  >PsiBuilder.Marker.precede()</code> is useful for right-to-left parsing when you don't know how many markers you need at a specific position until you read more input. For example, a binary expression <code class="code " id="6121e043_75"  >a+b+c</code> needs to be parsed as <code class="code " id="6121e043_76"  >( (a+b) + c )</code>. Thus, two start markers are needed at the position of the token 'a', but that is not known until the token 'c' is read. When the parser reaches the '+' token following 'b', it can call <code class="code " id="6121e043_77"  >precede()</code> to duplicate the start marker at 'a' position, and then put its matching end marker after 'c'.</p><section class="chapter"  ><h3 id="whitespace-and-comments" data-toc="whitespace-and-comments"  >Whitespace and Comments</h3><p id="6121e043_78" >An essential feature of <code class="code " id="6121e043_79"  >PsiBuilder</code> is its handling of whitespace and comments. The types of tokens which are treated as whitespace or comments are defined by <code class="code " id="6121e043_80"  >getWhitespaceTokens()</code> and <code class="code " id="6121e043_81"  >getCommentTokens()</code> in <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/lang/ParserDefinition.java" id="6121e043_82"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_83"  >ParserDefinition</code></a>. <code class="code " id="6121e043_84"  >PsiBuilder</code> automatically omits whitespace and comment tokens from the stream of tokens it passes to <code class="code " id="6121e043_85"  >PsiParser</code> and adjusts the token ranges of AST nodes so that leading and trailing whitespace tokens are not included in the node.</p><p id="6121e043_86" >Most languages will not need to override <code class="code " id="6121e043_87"  >getWhitespaceTokens()</code> which returns the language-agnostic <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/tree/TokenSet.java" id="6121e043_88"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_89"  >TokenSet.WHITE_SPACE</code></a> by default. The token set returned from <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/lang/ParserDefinition.java" id="6121e043_90"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_91"  >ParserDefinition.getCommentTokens()</code></a> is also used to search for <a href="https://www.jetbrains.com/help/idea/using-todo.html" id="6121e043_92"   data-external="true" rel="noopener noreferrer" >TODO items</a>.</p><p id="6121e043_93" >To better understand the process of building a PSI tree for a simple expression, you can refer to the following diagram:</p><figure  id="6121e043_94"><img alt="PsiBuilder" title="PsiBuilder" src="images/PsiBuilder.gif"  class="" width="758" height="965"/></figure></section></section><section class="chapter"  ><h2 id="psi-implementation" data-toc="psi-implementation"  >PSI Implementation</h2><p id="6121e043_95" >In general, there is no single right way to implement a PSI for a custom language, and the plugin author can choose the PSI structure and set of methods that are the most convenient for the code which uses the PSI (error analysis, refactorings, and so on). However, one base interface needs to be used by a custom language PSI implementation to support features like <a href="rename-refactoring.html" id="6121e043_96" data-tooltip="The Rename refactoring operation is quite similar to that of Find Usages. It uses the same rules for locating the element to be renamed and the same index of words for finding the files that may have references to the element being renamed."  >Rename Refactoring</a> and <a href="find-usages.html" id="6121e043_97" data-tooltip="The Find Usages action is a multi-step process, and each step of the process requires involvement from the custom language plugin."  >Find Usages</a>. Every element which can be renamed or referenced (a class definition, a method definition and so on) needs to implement the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/PsiNamedElement.java" id="6121e043_98"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_99"  >PsiNamedElement</code></a> interface, with methods <code class="code " id="6121e043_100"  >getName()</code> and <code class="code " id="6121e043_101"  >setName()</code>.</p><p id="6121e043_102" >Several functions which can be used for implementing and using the PSI can be found in the <code class="code " id="6121e043_103"  >com.intellij.psi.util</code> package, and in particular in the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/util/PsiUtilCore.java" id="6121e043_104"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_105"  >PsiUtilCore</code></a> and <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/util/PsiTreeUtil.java" id="6121e043_106"   data-external="true" rel="noopener noreferrer" ><code class="code " id="6121e043_107"  >PsiTreeUtil</code></a> classes.</p><aside data-type="tip" class="prompt" data-title="" id="6121e043_108" ><p id="6121e043_109" >Use <a href="explore-api.html#31-use-internal-mode-and-psiviewer" id="6121e043_110" data-tooltip="As a plugin developer, you should enable internal mode in IntelliJ IDEA. This provides access to a suite of tools to help you develop, debug, and test IntelliJ Platform plugins."  >builtin tools and PsiViewer plugin</a> to explore and inspect PSI.</p></aside><p id="6121e043_111" >Please see <a href="indexing-and-psi-stubs.html" id="6121e043_112" data-tooltip="The indexing framework provides a quick way to locate specific elements, e.g., files containing a certain word or methods with a particular name, in large codebases. Plugin developers can use the existing indexes built by the IDE itself and build and use their own indexes."  >Indexing and PSI Stubs</a> for advanced topics.</p></section><div class="last-modified"> Last modified: 25 九月 2022</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="implementing-lexer.html">Implementing Lexer</a>   <a class="navigation-links__next" href="syntax-highlighting-and-error-highlighting.html">Syntax and Error Highlighting</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/storage/help-app/v5/app.js"></script></body></html>