<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8">  <meta name="built-on" content="2022-09-29T19:15:57.0881722"><meta name="build-number" content="${buildNumber}">    <meta name="keywords" content="">  <title>Virtual File System | IntelliJ Platform Plugin SDK</title><script id="virtual-toc-data" type="application/json">[{"id":"synchronous-and-asynchronous-refreshes","level":0,"title":"Synchronous and Asynchronous Refreshes","anchor":"#synchronous-and-asynchronous-refreshes"},{"id":"virtual-file-system-events","level":0,"title":"Virtual File System Events","anchor":"#virtual-file-system-events"}]</script>   <link href="https://resources.jetbrains.com/storage/help-app/v5/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- Open Graph --><meta property="og:title" content="Virtual File System | IntelliJ Platform Plugin SDK"/><meta property="og:description" content=""/><meta property="og:image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"/><meta property="og:site_name" content="IntelliJ Platform Plugin SDK Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="https://plugins.jetbrains.com/docs/intellij/virtual-file-system.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@JBPlatform"><meta name="twitter:title" content="Virtual File System | IntelliJ Platform Plugin SDK"><meta name="twitter:description" content=""><meta name="twitter:creator" content="@JBPlatform"><meta name="twitter:image:src" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "https://plugins.jetbrains.com/docs/intellij/virtual-file-system.html#webpage", "url": "https://plugins.jetbrains.com/docs/intellij/virtual-file-system.html", "name": "Virtual File System | IntelliJ Platform Plugin SDK", "description": "", "image": "https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "https://plugins.jetbrains.com/docs/intellij/#website", "url": "https://plugins.jetbrains.com/docs/intellij/", "name": "IntelliJ Platform Plugin SDK Help" }</script><!-- End Schema.org --></head>    <body data-id="virtual_file_system.md" data-main-title="Virtual File System" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Part II — Base Platform///files.md|Files"  data-edit-url="https://github.com/JetBrains/intellij-sdk-docs/edit/main/topics/basics/virtual_file_system.md"  >  <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>IntelliJ Platform Plugin SDK  Help</h3><div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select class="select _shortcuts" height="1" id="switch-shortcuts">      </select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="virtual_file_system.md" id="virtual_file_system.md"  >Virtual File System</h1><p id="e2b9f933_73" >The Virtual File System (VFS) is a component of the IntelliJ Platform that encapsulates most of its activity for working with files represented as <a href="virtual-file.html" id="e2b9f933_74" data-tooltip="A VirtualFile (VF) is the IntelliJ Platform's representation of a file in a Virtual File System (VFS)."  >Virtual File</a>.</p><p id="e2b9f933_75" >It serves the following main purposes:</p><ul class="list _ul" id="e2b9f933_76"    ><li class="list__item" id="e2b9f933_77" ><p>Providing a universal API for working with files regardless of their actual location (on disk, in an archive, on an HTTP server, etc.)</p></li><li class="list__item" id="e2b9f933_78" ><p>Tracking file modifications and providing both old and new versions of the file content when a change is detected.</p></li><li class="list__item" id="e2b9f933_79" ><p>Providing a possibility to associate additional persistent data with a file in the VFS.</p></li></ul><p id="e2b9f933_80" >To provide the last two features, the VFS manages a <span class="emphasis" id="e2b9f933_81" >persistent snapshot</span> of some of the user's hard disk contents. The snapshot stores only those files which have been requested at least once through the VFS API, and is asynchronously updated to match the changes happening on the disk.</p><p id="e2b9f933_82" >The snapshot is application level, not project level - so, if some file (for example, a class in the JDK) is referenced by multiple projects, only one copy of its contents will be stored in the VFS.</p><p id="e2b9f933_83" >All VFS access operations go through the snapshot.</p><p id="e2b9f933_84" >If some information is requested through the VFS APIs and is not available in the snapshot, it is loaded from disk and stored into the snapshot. If the information is available in the snapshot, the snapshot data is returned. The contents of files and the lists of files in directories are stored in the snapshot only if that specific information was accessed. Otherwise, only file metadata like name, length, timestamp, attributes are stored.</p><aside data-type="tip" class="prompt" data-title="" id="e2b9f933_85" ><p id="e2b9f933_86" >This means that the state of the file system and the file contents displayed in the IntelliJ Platform UI comes from the snapshot, which may not always match the disk's actual contents. For example, in some cases, deleted files can still be visible in the UI for some time before the deletion is picked up by the IntelliJ Platform.</p></aside><p id="e2b9f933_87" >The snapshot is updated from disk during <span class="emphasis" id="e2b9f933_88" >refresh operations</span>, which generally happen asynchronously. All write operations made through the VFS are synchronous - i.e., the contents are saved to disk immediately.</p><p id="e2b9f933_89" >A refresh operation synchronizes the state of a part of the VFS with the actual disk contents. Refresh operations are explicitly invoked by the IntelliJ Platform or plugin code - i.e., when a file is changed on disk while the IDE is running, the change will not be immediately picked up by the VFS. The VFS will be updated during the next refresh operation, which includes the file in its scope.</p><p id="e2b9f933_90" >IntelliJ Platform refreshes the entire project contents asynchronously on startup. By default, it performs a refresh operation when the user switches to it from another app. Still, users can turn this off via .</p><p id="e2b9f933_92" >On Windows, Mac, and Linux, a native file watcher process is started that receives file change notifications from the file system and reports them to the IntelliJ Platform. If a file watcher is available, a refresh operation looks only at the files that have been reported as changed by the file watcher. If no file watcher is present, a refresh operation walks through all directories and files in the refresh scope.</p><aside data-type="tip" class="prompt" data-title="" id="e2b9f933_93" ><p id="e2b9f933_94" >Invoke <a href="internal-actions-intro.html" id="e2b9f933_95" data-tooltip="工具 | 内部操作 菜单提供给插件开发者一系列工具来帮助开发, 调试以及测试它们开发的IntelliJ Platform插件."  >internal action</a> to see all registered roots for current project.</p></aside><p id="e2b9f933_97" >Refresh operations are based on file timestamps. If a file's contents were changed, but its timestamp remained the same, the IntelliJ Platform will not pick up the updated contents.</p><p id="e2b9f933_98" >There is currently no facility for removing files from the snapshot. If a file was loaded there once, it remains there forever unless it was deleted from the disk, and a refresh operation was called on one of its parent directories.</p><p id="e2b9f933_99" >The VFS itself does not honor ignored files listed in  and folders to ignore and excluded folders listed in . If the application code accesses them, the VFS will load and return their contents. In most cases, the ignored files and excluded folders must be skipped from processing by higher-level code.</p><p id="e2b9f933_102" >During the lifetime of a running instance of an IntelliJ Platform IDE, multiple <code class="code " id="e2b9f933_103"  >VirtualFile</code> instances may correspond to the same disk file. They are equal, have the same <code class="code " id="e2b9f933_104"  >hashCode</code>, and share the user data.</p><section class="chapter"  ><h2 id="synchronous-and-asynchronous-refreshes" data-toc="synchronous-and-asynchronous-refreshes"  >Synchronous and Asynchronous Refreshes</h2><p id="e2b9f933_105" >From the point of view of the caller, refresh operations can be either synchronous or asynchronous. In fact, the refresh operations are executed according to their own threading policy. The synchronous flag simply means that the calling thread will be blocked until the refresh operation (which will most likely run on a different thread) is completed.</p><p id="e2b9f933_106" >Both synchronous and asynchronous refreshes can be initiated from any thread. If a refresh is initiated from a background thread, the calling thread must not hold a read action, because otherwise, a deadlock would occur. See <a href="general-threading-rules.html" id="e2b9f933_107" data-tooltip="Thread Access Info 插件在调试器中可视化显示读/写锁访问以及线程信息."  >IntelliJ Platform Architectural Overview</a> for more details on the threading model and read/write actions.</p><p id="e2b9f933_108" >The same threading requirements also apply to functions like <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/analysis-api/src/com/intellij/openapi/vfs/LocalFileSystem.java" id="e2b9f933_109"   data-external="true" rel="noopener noreferrer" ><code class="code " id="e2b9f933_110"  >LocalFileSystem.refreshAndFindFileByPath()</code></a>, which perform a partial refresh if the file with the specified path is not found in the snapshot.</p><p id="e2b9f933_111" >In nearly all cases, using asynchronous refreshes is strongly preferred. If there is some code that needs to be executed after the refresh is complete, the code should be passed as a <code class="code " id="e2b9f933_112"  >postRunnable</code> parameter to one of the refresh methods:</p><ul class="list _ul" id="e2b9f933_113"    ><li class="list__item" id="e2b9f933_114" ><p><a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/analysis-api/src/com/intellij/openapi/vfs/newvfs/RefreshQueue.java" id="e2b9f933_115"   data-external="true" rel="noopener noreferrer" ><code class="code " id="e2b9f933_116"  >RefreshQueue.createSession()</code></a></p></li><li class="list__item" id="e2b9f933_117" ><p><a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/openapi/vfs/VirtualFile.java" id="e2b9f933_118"   data-external="true" rel="noopener noreferrer" ><code class="code " id="e2b9f933_119"  >VirtualFile.refresh()</code></a></p></li></ul><p id="e2b9f933_120" >In some cases, synchronous refreshes can cause deadlocks, depending on which locks are held by the thread invoking the refresh operation.</p></section><section class="chapter"  ><h2 id="virtual-file-system-events" data-toc="virtual-file-system-events"  >Virtual File System Events</h2><p id="e2b9f933_121" >All changes happening in the virtual file system, either due to refresh operations or caused by user actions, are reported as <span class="emphasis" id="e2b9f933_122" >virtual file system events</span>. VFS events are always fired in the event dispatch thread and in a write action.</p><p id="e2b9f933_123" >The most efficient way to listen to VFS events is to implement <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/openapi/vfs/newvfs/BulkFileListener.java" id="e2b9f933_124"   data-external="true" rel="noopener noreferrer" ><code class="code " id="e2b9f933_125"  >BulkFileListener</code></a> and to subscribe with it to the <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/openapi/vfs/VirtualFileManager.java" id="e2b9f933_126"   data-external="true" rel="noopener noreferrer" ><code class="code " id="e2b9f933_127"  >VirtualFileManager.VFS_CHANGES</code></a> topic. A non-blocking variant <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/openapi/vfs/AsyncFileListener.java" id="e2b9f933_128"   data-external="true" rel="noopener noreferrer" ><code class="code " id="e2b9f933_129"  >AsyncFileListener</code></a> is also available in 2019.2 or later. See <a href="virtual-file.html#how-do-i-get-notified-when-vfs-changes" id="e2b9f933_130" data-tooltip="See Virtual file system events for important details."  >How do I get notified when VFS changes?</a> for implementation details.</p><aside data-type="tip" class="prompt" data-title="" id="e2b9f933_131" ><p id="e2b9f933_132" >VFS listeners are application level and will receive events for changes happening in <span class="emphasis" id="e2b9f933_133" >all</span> the projects opened by the user. You may need to filter out events that aren't relevant to your task (e.g., via <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/projectModel-api/src/com/intellij/openapi/roots/ProjectFileIndex.java" id="e2b9f933_134"   data-external="true" rel="noopener noreferrer" ><code class="code " id="e2b9f933_135"  >ProjectFileIndex.isInContent()</code></a>).</p></aside><p id="e2b9f933_136" >VFS events are sent both before and after each change, and you can access the old contents of the file in the before event. Note that events caused by a refresh are sent after the changes have already occurred on disk. So when you process the <code class="code " id="e2b9f933_137"  >beforeFileDeletion</code> event, for example, the file has already been deleted from disk. However, it is still present in the VFS snapshot, and you can access its last contents using the VFS API.</p><p id="e2b9f933_138" >Note that a refresh operation fires events only for changes in files that have been loaded in the snapshot. For example, if you accessed a <code class="code " id="e2b9f933_139"  >VirtualFile</code> for a directory but never loaded its contents using <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/openapi/vfs/VirtualFile.java" id="e2b9f933_140"   data-external="true" rel="noopener noreferrer" ><code class="code " id="e2b9f933_141"  >VirtualFile.getChildren()</code></a>, you may not get <code class="code " id="e2b9f933_142"  >fileCreated</code> notifications when files are created in that directory.</p><p id="e2b9f933_143" >If you loaded only a single file in a directory using <code class="code " id="e2b9f933_144"  >VirtualFile.findChild()</code>, you will get notifications for changes to that file, but you may not get created/deleted notifications for other files in the same directory.</p></section><div class="last-modified"> Last modified: 29 九月 2022</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="files.html">Files</a>   <a class="navigation-links__next" href="virtual-file.html">Virtual Files</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/storage/help-app/v5/app.js"></script></body></html>