<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8">  <meta name="built-on" content="2022-09-29T19:15:57.0881722"><meta name="build-number" content="${buildNumber}">    <meta name="keywords" content="">  <title>Indexing and PSI Stubs | IntelliJ Platform Plugin SDK</title><script id="virtual-toc-data" type="application/json">[{"id":"indexes","level":0,"title":"Indexes","anchor":"#indexes"},{"id":"dumb-mode","level":0,"title":"Dumb Mode","anchor":"#dumb-mode"},{"id":"gists","level":0,"title":"Gists","anchor":"#gists"},{"id":"improving-indexing-performance","level":0,"title":"Improving Indexing Performance","anchor":"#improving-indexing-performance"}]</script>   <link href="https://resources.jetbrains.com/storage/help-app/v5/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- Open Graph --><meta property="og:title" content="Indexing and PSI Stubs | IntelliJ Platform Plugin SDK"/><meta property="og:description" content=""/><meta property="og:image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"/><meta property="og:site_name" content="IntelliJ Platform Plugin SDK Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="https://plugins.jetbrains.com/docs/intellij/indexing-and-psi-stubs.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@JBPlatform"><meta name="twitter:title" content="Indexing and PSI Stubs | IntelliJ Platform Plugin SDK"><meta name="twitter:description" content=""><meta name="twitter:creator" content="@JBPlatform"><meta name="twitter:image:src" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "https://plugins.jetbrains.com/docs/intellij/indexing-and-psi-stubs.html#webpage", "url": "https://plugins.jetbrains.com/docs/intellij/indexing-and-psi-stubs.html", "name": "Indexing and PSI Stubs | IntelliJ Platform Plugin SDK", "description": "", "image": "https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "https://plugins.jetbrains.com/docs/intellij/#website", "url": "https://plugins.jetbrains.com/docs/intellij/", "name": "IntelliJ Platform Plugin SDK Help" }</script><!-- End Schema.org --></head>    <body data-id="indexing_and_psi_stubs.md" data-main-title="Indexing and PSI Stubs" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Part IV — PSI"  data-edit-url="https://github.com/JetBrains/intellij-sdk-docs/edit/main/topics/basics/indexing_and_psi_stubs.md"  >  <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>IntelliJ Platform Plugin SDK  Help</h3><div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select class="select _shortcuts" height="1" id="switch-shortcuts">      </select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="indexing_and_psi_stubs.md" id="indexing_and_psi_stubs.md"  >Indexing and PSI Stubs</h1><section class="chapter"  ><h2 id="indexes" data-toc="indexes"  >Indexes</h2><p id="a766080e_72" >The indexing framework provides a quick way to locate specific elements, e.g., files containing a certain word or methods with a particular name, in large codebases. Plugin developers can use the existing indexes built by the IDE itself and build and use their own indexes.</p><p id="a766080e_73" >It supports two main types of indexes:</p><ul class="list _ul" id="a766080e_74"    ><li class="list__item" id="a766080e_75" ><p><a href="file-based-indexes.html" id="a766080e_76" data-tooltip="File-based indexes are based on a Map/Reduce architecture. Each index has a specific type of key and a particular type of value."  >File-Based Indexes</a></p></li><li class="list__item" id="a766080e_77" ><p><a href="stub-indexes.html" id="a766080e_78" data-tooltip="A stub tree is a subset of the PSI tree for a file; it is stored in a compact serialized binary format. The PSI tree for a file can be backed either by the AST (built by parsing the file) or by the stub tree deserialized from disk. Switching between the two is transparent."  >Stub Indexes</a></p></li></ul><p id="a766080e_79" >File-based indexes are built directly over the content of files. Stub indexes are built over serialized <span class="emphasis" id="a766080e_80" >stub trees</span>. A stub tree for a source file is a subset of its PSI tree, which contains only externally visible declarations and is serialized in a compact binary format.</p><p id="a766080e_81" >Querying a file-based index gets you the set of files matching a specific condition. Querying a stub index gets you the set of matching PSI elements. Therefore, custom language plugin developers typically use stub indexes in their plugin implementations.</p><aside data-type="tip" class="prompt" data-title="" id="a766080e_82" ><p id="a766080e_83" ><a href="https://plugins.jetbrains.com/plugin/13029-index-viewer/" id="a766080e_84"   data-external="true" rel="noopener noreferrer" >Index Viewer</a> plugin can be used to inspect indexes' contents and properties.</p></aside></section><section class="chapter"  ><h2 id="dumb-mode" data-toc="dumb-mode"  >Dumb Mode</h2><p id="a766080e_85" >Indexing is a potentially lengthy process. It's performed in the background, and during this time, IDE features are restricted to the ones that don't require index: basic text editing, version control, etc. This restriction is managed by <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/openapi/project/DumbService.java" id="a766080e_86"   data-external="true" rel="noopener noreferrer" ><code class="code " id="a766080e_87"  >DumbService</code></a>. Violations are reported via <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/openapi/project/IndexNotReadyException.java" id="a766080e_88"   data-external="true" rel="noopener noreferrer" ><code class="code " id="a766080e_89"  >IndexNotReadyException</code></a>, please see its javadoc on how to adapt callers.</p><p id="a766080e_90" ><code class="code " id="a766080e_91"  >DumbService</code> provides API to query whether the IDE is currently in &quot;dumb&quot; mode (where index access is not allowed) or &quot;smart&quot; mode (with all index built and ready to use). It also provides ways of delaying code execution until indexes are ready. Please see its JavaDoc for more details.</p></section><section class="chapter"  ><h2 id="gists" data-toc="gists"  >Gists</h2><p id="a766080e_92" >Sometimes, the following conditions hold:</p><ul class="list _ul" id="a766080e_93"    ><li class="list__item" id="a766080e_94" ><p>The aggregation functionality of file-based indexes is not needed. One just needs to calculate some data based on a particular file's contents and cache it on disk.</p></li><li class="list__item" id="a766080e_95" ><p>Eagerly calculating the data for the entire project during indexing isn't needed (e.g., it slows down the indexing, and/or this data probably will ever be required for a minor subset of all project files).</p></li><li class="list__item" id="a766080e_96" ><p>The data can be recalculated lazily on request without significant performance penalties.</p></li></ul><p id="a766080e_97" >A <a href="file-based-indexes.html" id="a766080e_98" data-tooltip="File-based indexes are based on a Map/Reduce architecture. Each index has a specific type of key and a particular type of value."  >file-based index</a> can be used in such cases, but file gists provide a way to perform data calculation lazily, caching on disk, and a more lightweight API. Please see <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/indexing-api/src/com/intellij/util/gist/VirtualFileGist.java" id="a766080e_99"   data-external="true" rel="noopener noreferrer" ><code class="code " id="a766080e_100"  >VirtualFileGist</code></a> and <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/indexing-api/src/com/intellij/util/gist/PsiFileGist.java" id="a766080e_101"   data-external="true" rel="noopener noreferrer" ><code class="code " id="a766080e_102"  >PsiFileGist</code></a> documentation.</p><p id="a766080e_103" ><span class="control" id="a766080e_104" >Example:</span></p><ul class="list _ul" id="a766080e_105"    ><li class="list__item" id="a766080e_106" ><p><code class="code " id="a766080e_107"  >VirtualFileGist</code>: <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/images/src/org/intellij/images/index/ImageInfoIndex.java" id="a766080e_108"   data-external="true" rel="noopener noreferrer" ><code class="code " id="a766080e_109"  >ImageInfoIndex</code></a> calculating image dimensions/bit depth needed to be displayed in specific parts of UI.</p></li><li class="list__item" id="a766080e_110" ><p><code class="code " id="a766080e_111"  >PsiFileGist</code>: <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/java/java-indexing-impl/src/com/intellij/psi/impl/JavaSimplePropertyGist.kt" id="a766080e_112"   data-external="true" rel="noopener noreferrer" ><code class="code " id="a766080e_113"  >JavaSimplePropertyGist</code></a> providing simple properties in Java</p></li></ul></section><section class="chapter"  ><h2 id="improving-indexing-performance" data-toc="improving-indexing-performance"  >Improving Indexing Performance</h2><section class="chapter"  ><h3 id="performance-metrics" data-toc="performance-metrics"  >Performance Metrics</h3><p id="a766080e_114" >Indexing performance metrics in JSON format are generated in <a href="https://intellij-support.jetbrains.com/hc/en-us/articles/206544519-Directories-used-by-the-IDE-to-store-settings-caches-plugins-and-logs" id="a766080e_115"   data-external="true" rel="noopener noreferrer" >logs directory</a> (see <a href="ide-development-instance.html#the-development-instance-sandbox-directory" id="a766080e_116" data-tooltip="The Sandbox Home directory contains the settings, caches, logs, and plugins for a Development Instance of the IDE. This information is stored in a different location than for the installed IDE itself."  >sandbox directory</a> for development instance) in 2020.2 and later. These are additionally available in HTML format starting with 2021.1.</p></section><section class="chapter"  ><h3 id="avoid-using-ast" data-toc="avoid-using-ast"  >Avoid Using AST</h3><p id="a766080e_117" >Use <a href="implementing-lexer.html" id="a766080e_118" data-tooltip="A Lexer defines how a file's contents are broken into tokens."  >lexer</a> information instead of parsed trees if possible.</p><p id="a766080e_119" >If impossible, use light AST which doesn't create memory-hungry AST nodes inside, so traversing it might be faster. Obtain <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/lang/LighterAST.java" id="a766080e_120"   data-external="true" rel="noopener noreferrer" ><code class="code " id="a766080e_121"  >LighterAST</code></a> by casting <code class="code " id="a766080e_122"  >FileContent</code> input parameter to <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/util/indexing/PsiDependentFileContent.java" id="a766080e_123"   data-external="true" rel="noopener noreferrer" ><code class="code " id="a766080e_124"  >PsiDependentFileContent</code></a> and calling <code class="code " id="a766080e_125"  >getLighterAST()</code>. Make sure to traverse only the nodes you need to. See also <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-impl/src/com/intellij/psi/impl/source/tree/LighterASTNodeVisitor.java" id="a766080e_126"   data-external="true" rel="noopener noreferrer" ><code class="code " id="a766080e_127"  >LighterASTNodeVisitor</code></a> and <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-impl/src/com/intellij/psi/impl/source/tree/LightTreeUtil.java" id="a766080e_128"   data-external="true" rel="noopener noreferrer" ><code class="code " id="a766080e_129"  >LightTreeUtil</code></a> for useful utility methods.</p><p id="a766080e_130" >For <a href="stub-indexes.html" id="a766080e_131" data-tooltip="A stub tree is a subset of the PSI tree for a file; it is stored in a compact serialized binary format. The PSI tree for a file can be backed either by the AST (built by parsing the file) or by the stub tree deserialized from disk. Switching between the two is transparent."  >stub index</a>, implement <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-impl/src/com/intellij/psi/stubs/LightStubBuilder.java" id="a766080e_132"   data-external="true" rel="noopener noreferrer" ><code class="code " id="a766080e_133"  >LightStubBuilder</code></a>.</p><p id="a766080e_134" >If a custom language contains lazy-parseable elements that never or rarely contain any stubs, consider implementing <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/StubBuilder.java" id="a766080e_135"   data-external="true" rel="noopener noreferrer" ><code class="code " id="a766080e_136"  >StubBuilder.skipChildProcessingWhenBuildingStubs()</code></a> (preferably using Lexer/node text).</p><p id="a766080e_137" >For indexing XML, also consider using <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/indexing-impl/src/com/intellij/util/xml/NanoXmlUtil.java" id="a766080e_138"   data-external="true" rel="noopener noreferrer" ><code class="code " id="a766080e_139"  >NanoXmlUtil</code></a>.</p></section><section class="chapter"  ><h3 id="consider-prebuilt-stubs" data-toc="consider-prebuilt-stubs"  >Consider Prebuilt Stubs</h3><p id="a766080e_140" >If your language has a massive standard library, which is mostly the same for all users, you can avoid stub-indexing it in each installation by providing prebuilt stubs with your distribution. See <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/indexing-impl/src/com/intellij/psi/stubs/PrebuiltStubs.kt" id="a766080e_141"   data-external="true" rel="noopener noreferrer" ><code class="code " id="a766080e_142"  >PrebuiltStubsProvider</code></a> extension.</p></section></section><div class="last-modified"> Last modified: 29 九月 2022</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="psi-performance.html">PSI Performance</a>   <a class="navigation-links__next" href="file-based-indexes.html">File-Based Indexes</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/storage/help-app/v5/app.js"></script></body></html>