<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8">  <meta name="built-on" content="2022-09-25T22:17:41.9708092"><meta name="build-number" content="${buildNumber}">    <meta name="keywords" content="">  <title>PSI Performance | IntelliJ Platform Plugin SDK</title><script id="virtual-toc-data" type="application/json">[{"id":"avoid-expensive-methods-of-psielement","level":0,"title":"Avoid Expensive Methods of PsiElement","anchor":"#avoid-expensive-methods-of-psielement"},{"id":"avoid-using-many-psi-treesdocuments","level":0,"title":"Avoid Using Many PSI Trees/Documents","anchor":"#avoid-using-many-psi-treesdocuments"},{"id":"cache-results-of-heavy-computations","level":0,"title":"Cache Results of Heavy Computations","anchor":"#cache-results-of-heavy-computations"}]</script>   <link href="https://resources.jetbrains.com/storage/help-app/v5/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- Open Graph --><meta property="og:title" content="PSI Performance | IntelliJ Platform Plugin SDK"/><meta property="og:description" content=""/><meta property="og:image" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"/><meta property="og:site_name" content="IntelliJ Platform Plugin SDK Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="https://plugins.jetbrains.com/docs/intellij/psi-performance.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@JBPlatform"><meta name="twitter:title" content="PSI Performance | IntelliJ Platform Plugin SDK"><meta name="twitter:description" content=""><meta name="twitter:creator" content="@JBPlatform"><meta name="twitter:image:src" content="https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png"><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "https://plugins.jetbrains.com/docs/intellij/psi-performance.html#webpage", "url": "https://plugins.jetbrains.com/docs/intellij/psi-performance.html", "name": "PSI Performance | IntelliJ Platform Plugin SDK", "description": "", "image": "https://resources.jetbrains.com/storage/products/jetbrains/img/meta/preview.png", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "https://plugins.jetbrains.com/docs/intellij/#website", "url": "https://plugins.jetbrains.com/docs/intellij/", "name": "IntelliJ Platform Plugin SDK Help" }</script><!-- End Schema.org --></head>    <body data-id="psi_performance.md" data-main-title="PSI Performance" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Part IV — PSI"  data-edit-url="https://github.com/JetBrains/intellij-sdk-docs/edit/main/topics/basics/architectural_overview/psi_performance.md"  >  <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>IntelliJ Platform Plugin SDK  Help</h3><div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select class="select _shortcuts" height="1" id="switch-shortcuts">      </select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="psi_performance.md" id="psi_performance.md"  >PSI Performance</h1><p id="f2543ca4_1" >See also <a href="general-threading-rules.html#avoiding-ui-freezes" id="f2543ca4_2" data-tooltip="In particular, don't traverse , parse PSI, resolve references or query indexes/stubs."  >Avoiding UI Freezes</a> and <a href="indexing-and-psi-stubs.html#improving-indexing-performance" id="f2543ca4_3" data-tooltip="Indexing performance metrics in JSON format are generated in logs directory (see sandbox directory for development instance) in 2020.2 and later. These are additionally available in HTML format starting with 2021.1."  >Improving Indexing Performance</a>.</p><aside data-type="tip" class="prompt" data-title="" id="f2543ca4_4" ><p id="f2543ca4_5" ><a href="https://plugins.jetbrains.com/plugin/15104-ide-perf" id="f2543ca4_6"   data-external="true" rel="noopener noreferrer" >IDE Perf</a> plugin provides on-the-fly performance diagnostic tools, including a dedicated view for <a href="#cache-results-of-heavy-computations" id="f2543ca4_7" data-tooltip="Method calls such as PsiElement.getReference(s), PsiReference.resolve() (and multiResolve() and other equivalents) or computation of expression types, type inference results, control flow graphs, etc. can be expensive. To avoid paying this cost several times, the result of such…"  ><code class="code " id="f2543ca4_8"  >CachedValue</code></a> metrics.</p></aside><section class="chapter"  ><h2 id="avoid-expensive-methods-of-psielement" data-toc="avoid-expensive-methods-of-psielement"  >Avoid Expensive Methods of PsiElement</h2><p id="f2543ca4_9" >Avoid <code class="code " id="f2543ca4_10"  >PsiElement</code>'s methods which are expensive with deep trees.</p><p id="f2543ca4_11" ><code class="code " id="f2543ca4_12"  >getText()</code> traverses the whole tree under the given element and concatenates strings, consider using <code class="code " id="f2543ca4_13"  >textMatches()</code> instead.</p><p id="f2543ca4_14" ><code class="code " id="f2543ca4_15"  >getTextRange()</code>, <code class="code " id="f2543ca4_16"  >getContainingFile()</code>, and <code class="code " id="f2543ca4_17"  >getProject()</code> traverse the tree up to the file, which can be long in very nested trees. If you only need PSI element length, use <code class="code " id="f2543ca4_18"  >getTextLength()</code>.</p><p id="f2543ca4_19" ><code class="code " id="f2543ca4_20"  >getContainingFile()</code> and <code class="code " id="f2543ca4_21"  >getProject()</code> often can be computed once per task and then stored in fields or passed via parameters.</p><p id="f2543ca4_22" >Additionally, methods such as <code class="code " id="f2543ca4_23"  >getText()</code>, <code class="code " id="f2543ca4_24"  >getNode()</code>, or <code class="code " id="f2543ca4_25"  >getTextRange()</code>, need the AST, obtaining which can be quite an expensive operation, see next section.</p></section><section class="chapter"  ><h2 id="avoid-using-many-psi-treesdocuments" data-toc="avoid-using-many-psi-treesdocuments"  >Avoid Using Many PSI Trees/Documents</h2><p id="f2543ca4_26" >Avoid loading too many parsed trees or documents into memory at the same time. Ideally, only AST nodes from files open in the editor should be present in the memory. Everything else, even if it's needed for resolve/highlighting purposes, can be accessed via PSI interfaces, but its implementations should <a href="stub-indexes.html" id="f2543ca4_27" data-tooltip="A stub tree is a subset of the PSI tree for a file; it is stored in a compact serialized binary format. The PSI tree for a file can be backed either by the AST (built by parsing the file) or by the stub tree deserialized from disk. Switching between the two is transparent."  >use stubs</a> underneath, which are less CPU- and memory-expensive.</p><p id="f2543ca4_28" >If stubs don't suit your case well (e.g., the information you need is large and/or very rarely needed, or you're developing a plugin for a language whose PSI you don't control), you can create a <a href="indexing-and-psi-stubs.html" id="f2543ca4_29" data-tooltip="The indexing framework provides a quick way to locate specific elements, e.g., files containing a certain word or methods with a particular name, in large codebases. Plugin developers can use the existing indexes built by the IDE itself and build and use their own indexes."  >custom index or gist</a>.</p><p id="f2543ca4_30" >To ensure you're not loading AST accidentally, you can use <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/util/AstLoadingFilter.java" id="f2543ca4_31"   data-external="true" rel="noopener noreferrer" ><code class="code " id="f2543ca4_32"  >AstLoadingFilter</code></a> in production and <code class="code " id="f2543ca4_33"  >PsiManagerEx.setAssertOnFileLoadingFilter()</code> in tests.</p><p id="f2543ca4_34" >The same applies to documents: only the ones opened in editors should be loaded. Usually, you shouldn't need document contents (as most information can be retrieved from PSI). If you nevertheless need documents, consider saving the information you need to provide in a <a href="indexing-and-psi-stubs.html" id="f2543ca4_35" data-tooltip="The indexing framework provides a quick way to locate specific elements, e.g., files containing a certain word or methods with a particular name, in large codebases. Plugin developers can use the existing indexes built by the IDE itself and build and use their own indexes."  >custom index or gist</a> to get it more cheaply later. If you still need documents, then at least ensure you load them one by one and don't hold them on strong references to let GC free the memory as quickly as possible.</p></section><section class="chapter"  ><h2 id="cache-results-of-heavy-computations" data-toc="cache-results-of-heavy-computations"  >Cache Results of Heavy Computations</h2><p id="f2543ca4_36" >Method calls such as <code class="code " id="f2543ca4_37"  >PsiElement.getReference(s)</code>, <code class="code " id="f2543ca4_38"  >PsiReference.resolve()</code> (and <code class="code " id="f2543ca4_39"  >multiResolve()</code> and other equivalents) or computation of expression types, type inference results, control flow graphs, etc. can be expensive. To avoid paying this cost several times, the result of such computation can be cached and reused. Usually, <a href="https://github.com/JetBrains/intellij-community/tree/idea/222.3739.54/platform/core-api/src/com/intellij/psi/util/CachedValue.java" id="f2543ca4_40"   data-external="true" rel="noopener noreferrer" ><code class="code " id="f2543ca4_41"  >CachedValue</code></a> works well for this purpose.</p><p id="f2543ca4_42" >If the information you cache depends only on a subtree of the current PSI element (and nothing else: no resolve results or other files), you can cache it in a field in your <code class="code " id="f2543ca4_43"  >PsiElement</code> implementation and drop the cache in an override of <code class="code " id="f2543ca4_44"  >ASTDelegatePsiElement.subtreeChanged()</code>.</p></section><div class="last-modified"> Last modified: 25 九月 2022</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="psi-cookbook.html">PSI Cookbook</a>   <a class="navigation-links__next" href="indexing-and-psi-stubs.html">Indexing and PSI Stubs</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/storage/help-app/v5/app.js"></script></body></html>